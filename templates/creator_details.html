{% extends "base.html" %}

{% block title %}設計師資料 - BGG 桌遊分析平台{% endblock %}

{% block content %}
<div class="container mt-4">
    <div id="loading" class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">載入中...</span>
        </div>
        <p class="mt-2">載入設計師資料中...</p>
    </div>
    
    <div id="creator-content" style="display: none;">
        <!-- 設計師基本資料與 Top Game -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <img id="creator-image" src="" alt="設計師照片" class="img-fluid rounded-circle mb-3" style="max-width: 150px;">
                    </div>
                    <div class="col-md-9">
                        <h2 id="creator-name" class="card-title"></h2>
                        <div class="mb-3">
                            <span id="creator-type" class="badge badge-secondary"></span>
                        </div>
                        
                        <!-- Top Game -->
                        <div id="top-game-section">
                            <h5>代表作品</h5>
                            <p class="mb-2">
                                <a id="top-game-link" href="#" target="_blank" class="text-decoration-none">
                                    <strong id="top-game-name"></strong>
                                </a>
                            </p>
                        </div>
                        
                        <!-- 追蹤按鈕 -->
                        <div class="mt-3">
                            <button id="follow-btn" class="btn btn-primary" onclick="toggleFollow()">
                                <span id="follow-text">追蹤</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 近期作品 -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">近期作品（按年份排序）</h4>
            </div>
            <div class="card-body">
                <div id="recent-games" class="row">
                    <!-- 作品列表將由 JavaScript 填充 -->
                </div>
                <div id="no-games" style="display: none;" class="text-muted">
                    目前沒有找到作品資料。
                </div>
            </div>
        </div>
    </div>
    
    <!-- 錯誤訊息 -->
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
</div>

<script>
let currentCreator = null;

// 頁面載入時獲取設計師資料
document.addEventListener('DOMContentLoaded', function() {
    const creatorId = {{ creator_id }};
    const creatorType = '{{ creator_type }}';
    loadCreatorDetails(creatorId, creatorType);
});

function loadCreatorDetails(creatorId, creatorType) {
    fetch(`/api/creators/${creatorId}/${creatorType}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                currentCreator = data.creator;
                displayCreatorDetails(data.creator);
                document.getElementById('creator-content').style.display = 'block';
            } else {
                showError(data.message || '載入設計師資料失敗');
            }
        })
        .catch(error => {
            console.error('載入設計師資料失敗:', error);
            document.getElementById('loading').style.display = 'none';
            showError('載入設計師資料失敗');
        });
}

function displayCreatorDetails(creator) {
    // 基本資料
    document.getElementById('creator-name').textContent = creator.name;
    document.getElementById('creator-type').textContent = creator.type === 'designer' ? '設計師' : '繪師';
    
    // 照片
    if (creator.image_url) {
        document.getElementById('creator-image').src = creator.image_url;
        document.getElementById('creator-image').style.display = 'block';
    } else {
        document.getElementById('creator-image').style.display = 'none';
    }
    
    // Top Game
    if (creator.top_game) {
        document.getElementById('top-game-name').textContent = creator.top_game.name;
        document.getElementById('top-game-link').href = creator.top_game.url;
        document.getElementById('top-game-section').style.display = 'block';
    } else {
        document.getElementById('top-game-section').style.display = 'none';
    }
    
    // 追蹤按鈕
    updateFollowButton(creator.is_following);
    
    // 近期作品
    displayRecentGames(creator.recent_games);
}

function displayRecentGames(games) {
    const container = document.getElementById('recent-games');
    container.innerHTML = '';
    
    if (games && games.length > 0) {
        games.forEach(game => {
            const gameDiv = document.createElement('div');
            gameDiv.className = 'col-md-6 col-lg-4 mb-3';
            
            gameDiv.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">
                            <a href="${game.url}" target="_blank" class="text-decoration-none">
                                ${game.name}
                            </a>
                        </h6>
                        <p class="card-text text-muted">
                            ${game.year ? game.year + '年' : '年份未知'}
                        </p>
                    </div>
                </div>
            `;
            
            container.appendChild(gameDiv);
        });
        document.getElementById('no-games').style.display = 'none';
    } else {
        document.getElementById('no-games').style.display = 'block';
    }
}

function updateFollowButton(isFollowing) {
    const btn = document.getElementById('follow-btn');
    const text = document.getElementById('follow-text');
    
    if (isFollowing) {
        btn.className = 'btn btn-outline-danger';
        text.textContent = '取消追蹤';
    } else {
        btn.className = 'btn btn-primary';
        text.textContent = '追蹤';
    }
}

function toggleFollow() {
    if (!currentCreator) return;
    
    const isCurrentlyFollowing = currentCreator.is_following;
    const action = isCurrentlyFollowing ? 'unfollow' : 'follow';
    
    const btn = document.getElementById('follow-btn');
    btn.disabled = true;
    
    fetch('/api/creators/follow', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            creator_id: currentCreator.id,
            type: currentCreator.type,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentCreator.is_following = !isCurrentlyFollowing;
            updateFollowButton(currentCreator.is_following);
            
            // 顯示成功訊息
            const message = isCurrentlyFollowing ? '已取消追蹤' : '開始追蹤';
            showMessage(message, 'success');
        } else {
            showMessage(data.message || '操作失敗', 'danger');
        }
    })
    .catch(error => {
        console.error('追蹤操作失敗:', error);
        showMessage('追蹤操作失敗', 'danger');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 3秒後自動隱藏
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}