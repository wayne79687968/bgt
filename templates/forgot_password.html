{% extends "base.html" %}

{% block title %}å¿˜è¨˜å¯†ç¢¼ - BGG ç¶œåˆåˆ†æå¹³å°{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-4">
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <h2 class="card-title mb-3">ğŸ” é‡è¨­å¯†ç¢¼</h2>
                        <p class="text-muted">è¼¸å…¥æ‚¨çš„ Email åœ°å€ä¾†é‡è¨­å¯†ç¢¼</p>
                    </div>
                    
                    <!-- æ­¥é©Ÿä¸€ï¼šè¼¸å…¥ Email -->
                    <div id="step1">
                        <form id="emailForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email åœ°å€</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="sendResetBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="emailSpinner"></span>
                                    ç™¼é€é‡è¨­ç¢¼
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- æ­¥é©ŸäºŒï¼šé©—è­‰é‡è¨­ç¢¼ -->
                    <div id="step2" class="d-none">
                        <form id="verifyForm">
                            <div class="alert alert-info">
                                <small>é‡è¨­ç¢¼å·²ç™¼é€åˆ° <strong id="emailDisplay"></strong></small>
                            </div>
                            <div class="mb-3">
                                <label for="resetCode" class="form-label">é‡è¨­ç¢¼</label>
                                <input type="text" class="form-control" id="resetCode" name="code" maxlength="6" placeholder="è«‹è¼¸å…¥6ä½æ•¸é‡è¨­ç¢¼" required>
                                <div class="form-text">é‡è¨­ç¢¼å°‡åœ¨10åˆ†é˜å¾Œå¤±æ•ˆ</div>
                            </div>
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-primary btn-lg" id="verifyBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="verifySpinner"></span>
                                    é©—è­‰
                                </button>
                            </div>
                            <div class="text-center">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="resendBtn">
                                    é‡æ–°ç™¼é€é‡è¨­ç¢¼
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- æ­¥é©Ÿä¸‰ï¼šè¨­å®šæ–°å¯†ç¢¼ -->
                    <div id="step3" class="d-none">
                        <form id="newPasswordForm">
                            <div class="alert alert-success">
                                <small>é©—è­‰æˆåŠŸï¼è«‹è¨­å®šæ–°å¯†ç¢¼</small>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">æ–°å¯†ç¢¼</label>
                                <input type="password" class="form-control" id="newPassword" name="password" minlength="6" required>
                                <div class="form-text">è‡³å°‘6å€‹å­—ç¬¦</div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmNewPassword" class="form-label">ç¢ºèªæ–°å¯†ç¢¼</label>
                                <input type="password" class="form-control" id="confirmNewPassword" name="confirmPassword" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg" id="resetBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="resetSpinner"></span>
                                    é‡è¨­å¯†ç¢¼
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <p><small><a href="{{ url_for('login') }}">è¿”å›ç™»å…¥</a></small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">ç³»çµ±é€šçŸ¥</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentEmail = '';
    let verifiedCode = '';
    
    // é¡¯ç¤ºé€šçŸ¥
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        
        toastMessage.textContent = message;
        toast.className = `toast ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : ''}`;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    // æ­¥é©Ÿä¸€ï¼šç™¼é€é‡è¨­ç¢¼
    document.getElementById('emailForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const sendResetBtn = document.getElementById('sendResetBtn');
        const emailSpinner = document.getElementById('emailSpinner');
        
        sendResetBtn.disabled = true;
        emailSpinner.classList.remove('d-none');
        
        try {
            const response = await fetch('/auth/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    type: 'password_reset'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentEmail = email;
                document.getElementById('emailDisplay').textContent = email;
                document.getElementById('step1').classList.add('d-none');
                document.getElementById('step2').classList.remove('d-none');
                showToast('é‡è¨­ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±', 'success');
            } else {
                showToast(result.message || 'ç™¼é€å¤±æ•—', 'error');
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        } finally {
            sendResetBtn.disabled = false;
            emailSpinner.classList.add('d-none');
        }
    });
    
    // æ­¥é©ŸäºŒï¼šé©—è­‰é‡è¨­ç¢¼
    document.getElementById('verifyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const code = document.getElementById('resetCode').value;
        const verifyBtn = document.getElementById('verifyBtn');
        const verifySpinner = document.getElementById('verifySpinner');
        
        verifyBtn.disabled = true;
        verifySpinner.classList.remove('d-none');
        
        try {
            const response = await fetch('/auth/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: currentEmail,
                    code: code,
                    type: 'password_reset'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                verifiedCode = code;
                document.getElementById('step2').classList.add('d-none');
                document.getElementById('step3').classList.remove('d-none');
                showToast('é©—è­‰æˆåŠŸï¼è«‹è¨­å®šæ–°å¯†ç¢¼', 'success');
            } else {
                showToast(result.message || 'é©—è­‰å¤±æ•—', 'error');
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        } finally {
            verifyBtn.disabled = false;
            verifySpinner.classList.add('d-none');
        }
    });
    
    // é‡æ–°ç™¼é€é‡è¨­ç¢¼
    document.getElementById('resendBtn').addEventListener('click', async function() {
        const resendBtn = this;
        resendBtn.disabled = true;
        
        try {
            const response = await fetch('/auth/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: currentEmail,
                    type: 'password_reset'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('é‡è¨­ç¢¼å·²é‡æ–°ç™¼é€', 'success');
                
                // å€’æ•¸è¨ˆæ™‚
                let countdown = 60;
                resendBtn.textContent = `é‡æ–°ç™¼é€ (${countdown})`;
                const timer = setInterval(() => {
                    countdown--;
                    resendBtn.textContent = `é‡æ–°ç™¼é€ (${countdown})`;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        resendBtn.textContent = 'é‡æ–°ç™¼é€é‡è¨­ç¢¼';
                        resendBtn.disabled = false;
                    }
                }, 1000);
            } else {
                showToast(result.message || 'ç™¼é€å¤±æ•—', 'error');
                resendBtn.disabled = false;
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            resendBtn.disabled = false;
        }
    });
    
    // æ­¥é©Ÿä¸‰ï¼šé‡è¨­å¯†ç¢¼
    document.getElementById('newPasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        
        if (newPassword !== confirmNewPassword) {
            showToast('å¯†ç¢¼ç¢ºèªä¸ä¸€è‡´', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            showToast('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'error');
            return;
        }
        
        const resetBtn = document.getElementById('resetBtn');
        const resetSpinner = document.getElementById('resetSpinner');
        
        resetBtn.disabled = true;
        resetSpinner.classList.remove('d-none');
        
        try {
            const response = await fetch('/auth/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: currentEmail,
                    code: verifiedCode,
                    password: newPassword
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('å¯†ç¢¼é‡è¨­æˆåŠŸï¼æ­£åœ¨è·³è½‰åˆ°ç™»å…¥é é¢...', 'success');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showToast(result.message || 'é‡è¨­å¤±æ•—', 'error');
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        } finally {
            resetBtn.disabled = false;
            resetSpinner.classList.add('d-none');
        }
    });
    
    // å¯†ç¢¼ç¢ºèªå³æ™‚é©—è­‰
    document.getElementById('confirmNewPassword').addEventListener('input', function() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = this.value;
        
        if (confirmNewPassword && newPassword !== confirmNewPassword) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
});
</script>
{% endblock %}