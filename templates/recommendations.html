{% extends "base.html" %}

{% block title %}éŠæˆ²æ¨è–¦ç³»çµ± - BGG æ¡ŒéŠåˆ†æå¹³å°{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">ğŸ§  å€‹äººåŒ–æ¨è–¦ç³»çµ±</h2>
        </div>
        <div class="card-body">
            <!-- ç®—æ³•é¸æ“‡ -->
            {% if available_algorithms %}
            <div class="mb-4">
                <label class="form-label"><strong>æ¨è–¦ç®—æ³•ï¼š</strong></label>
                <div class="btn-group" role="group">
                    {% for algo in available_algorithms %}
                    <a href="{{ url_for('recommendations', algorithm=algo.value) }}"
                       class="btn {% if current_algorithm == algo.value %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        {{ algo.name }}
                    </a>
                    {% endfor %}
                </div>
                <small class="form-text text-muted">
                    {% for algo in available_algorithms %}
                        {% if current_algorithm == algo.value %}{{ algo.description }}{% endif %}
                    {% endfor %}
                </small>
            </div>
            {% endif %}

            <!-- å–®ä¸€éŠæˆ²æ‰“åˆ†èªªæ˜ -->
            <div id="welcome-state" class="alert alert-info">
                å…ˆåœ¨ä¸‹æ–¹æœå°‹ä¸€æ¬¾æ¡ŒéŠï¼Œé»é¸çµæœå¾Œï¼Œç³»çµ±æœƒç”¨æ‚¨çš„æ¨¡å‹è¨ˆç®—ã€Œè©²éŠæˆ²ã€çš„å€‹äººåŒ–æ¨è–¦åˆ†æ•¸ã€‚
            </div>

            <!-- éŠæˆ²æœå°‹ -->
            <div class="mb-3" style="position: relative;">
                <input type="text" id="game-search-input" class="form-control"
                       placeholder="æœå°‹æ¡ŒéŠåç¨±..." autocomplete="off">
                <div id="search-results" class="border rounded shadow-sm bg-white"
                     style="position: absolute; top: 100%; left: 0; right: 0; max-height: 300px; overflow-y: auto; z-index: 1000; display: none;">
                </div>
            </div>

            <!-- ä¸å†é¡¯ç¤ºå¤šéŠæˆ²æ¸…å–®æˆ–ç”¢ç”Ÿç¸½è¡¨ -->
        </div>
    </div>

    <!-- æ¨è–¦çµæœ -->
    <div class="card" id="recommendations-section" style="display: none;">
        <div class="card-header bg-success text-white">
            <h2 class="mb-0">âœ¨ ç‚ºæ‚¨æ¨è–¦</h2>
        </div>
        <div class="card-body">
            <div id="recommendations-content"></div>
        </div>
    </div>
</div>

<script>
let selectedGames = [];
let searchTimeout = null;

// æœå°‹éŠæˆ²
document.getElementById('game-search-input').addEventListener('input', function(e) {
    const query = e.target.value.trim();

    clearTimeout(searchTimeout);

    if (query.length < 2) {
        hideSearchResults();
        return;
    }

    searchTimeout = setTimeout(() => {
        searchGames(query);
    }, 300);
});

// é»æ“Šå¤–éƒ¨éš±è—æœå°‹çµæœ
document.addEventListener('click', function(e) {
    if (!e.target.closest('#game-search-input') && !e.target.closest('#search-results')) {
        hideSearchResults();
    }
});

async function searchGames(query) {
    try {
        // ä½¿ç”¨çœŸæ­£çš„ BGG API æœå°‹
        const response = await fetch('/api/bgg/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                exact: 10
            })
        });

        const data = await response.json();

        if (data.success) {
            displaySearchResults(data.results);
        } else {
            console.error('æœå°‹å¤±æ•—:', data.message);
        }
    } catch (error) {
        console.error('æœå°‹éŒ¯èª¤:', error);
    }
}

function displaySearchResults(games) {
    const resultsDiv = document.getElementById('search-results');

    if (games.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-center text-muted">æ‰¾ä¸åˆ°ç›¸é—œéŠæˆ²</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.innerHTML = games.map(game => {
        return `
            <div class="p-2 border-bottom d-flex align-items-center" style="cursor: pointer;"
                 onclick="getGameRecommendation(${game.id}, '${game.name.replace(/'/g, "\'")}')">
                <img src="/static/images/default-game.png"
                     alt="${game.name}" class="me-2 rounded"
                     style="width: 40px; height: 40px; object-fit: cover;"
                     onerror="this.src='/static/images/default-game.png'">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${game.name}</h6>
                    <small class="text-muted">
                        BGG ID: ${game.id} |
                        å¹´ä»½: ${game.year || 'N/A'}
                    </small>
                </div>
                ${isSelected ? '<span class="text-success">âœ“ å·²é¸æ“‡</span>' : ''}
            </div>
        `;
    }).join('');

    resultsDiv.style.display = 'block';
}

function hideSearchResults() {
    document.getElementById('search-results').style.display = 'none';
}

// å–æ¶ˆå¤šé¸é‚è¼¯ï¼Œæ”¹ç”±é»æ“Šå³è¨ˆåˆ†

function removeGame(objectid) {
    selectedGames = selectedGames.filter(game => game.objectid !== objectid);
    updateSelectedGamesDisplay();

    if (selectedGames.length === 0) {
        document.getElementById('welcome-state').style.display = 'block';
    }
}

function updateSelectedGamesDisplay() {
    const container = document.getElementById('selected-games');
    const recommendBtn = document.getElementById('recommend-btn');

    if (selectedGames.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                è«‹æœå°‹ä¸¦é¸æ“‡æ‚¨å–œæ­¡çš„æ¡ŒéŠï¼ˆæœ€å¤š10æ¬¾ï¼‰
            </div>
        `;
        recommendBtn.disabled = true;
    } else {
        container.innerHTML = selectedGames.map(game => `
            <span class="badge bg-primary me-2 mb-2" style="font-size: 14px;">
                ${game.name}
                <button class="btn-close btn-close-white ms-2" style="font-size: 10px;"
                        onclick="removeGame(${game.objectid})" title="ç§»é™¤"></button>
            </span>
        `).join('');
        recommendBtn.disabled = false;
    }
}

async function getRecommendations() {
    const recommendBtn = document.getElementById('recommend-btn');
    const recommendationsSection = document.getElementById('recommendations-section');
    const recommendationsContent = document.getElementById('recommendations-content');

    if (selectedGames.length === 0) {
        alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€æ¬¾éŠæˆ²');
        return;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    recommendBtn.disabled = true;
    recommendBtn.textContent = 'åˆ†æä¸­...';

    recommendationsSection.style.display = 'block';
    recommendationsContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
            <p class="mt-2">æ­£åœ¨åˆ†ææ‚¨çš„åå¥½ä¸¦ç”Ÿæˆæ¨è–¦...</p>
        </div>
    `;

    try {
        const response = await fetch('/api/recommendations/by-games', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                games: selectedGames.map(game => game.objectid),
                num_recommendations: 10
            })
        });

        const data = await response.json();

        if (data.success) {
            displayRecommendations(data.recommendations, data.metadata || {});
        } else {
            recommendationsContent.innerHTML = `
                <div class="alert alert-danger">
                    æ¨è–¦å¤±æ•—: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('ç²å–æ¨è–¦å¤±æ•—:', error);
        recommendationsContent.innerHTML = `
            <div class="alert alert-danger">
                ç²å–æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚
            </div>
        `;
    } finally {
        recommendBtn.disabled = false;
        recommendBtn.textContent = 'é‡æ–°æ¨è–¦';
    }
}

function displayRecommendations(recommendations, metadata) {
    const content = document.getElementById('recommendations-content');

    if (recommendations.length === 0) {
        content.innerHTML = `
            <div class="text-center py-4">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¤·â€â™€ï¸</div>
                <h3>æš«ç„¡æ¨è–¦</h3>
                <p>æŠ±æ­‰ï¼Œæ ¹æ“šæ‚¨é¸æ“‡çš„éŠæˆ²ï¼Œæˆ‘å€‘æš«æ™‚æ‰¾ä¸åˆ°åˆé©çš„æ¨è–¦</p>
            </div>
        `;
        return;
    }

    content.innerHTML = `
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">ğŸ“Š æ¨è–¦åˆ†æ</h5>
            <p class="mb-0">
                åŸºæ–¼æ‚¨é¸æ“‡çš„ ${selectedGames.length} æ¬¾éŠæˆ²${metadata.methods_used ? `ï¼Œä½¿ç”¨ ${metadata.methods_used.join(' + ')} æ–¹æ³•` : ''}ï¼Œ
                ç‚ºæ‚¨æ¨è–¦ ${recommendations.length} æ¬¾é«˜å“è³ªæ¡ŒéŠ
            </p>
        </div>

        ${recommendations.map((rec, index) => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">${index + 1}. ${rec.name}</h5>
                        <span class="badge bg-success" style="font-size: 14px;">${rec.score}/10</span>
                    </div>
                    <div class="card-text">
                        <p class="mb-2">
                            <strong>BGG è©•åˆ†:</strong> ${rec.rating ? rec.rating.toFixed(1) : 'N/A'} |
                            <strong>æ’å:</strong> ${rec.rank || 'N/A'} |
                            <strong>æ¨è–¦æ–¹æ³•:</strong> ${rec.method || rec.source}
                        </p>
                        ${rec.similarity ? `<p class="mb-2"><strong>ç›¸ä¼¼åº¦:</strong> ${(rec.similarity * 100).toFixed(1)}%</p>` : ''}
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar"
                                 style="width: ${(rec.confidence * 100).toFixed(1)}%"
                                 aria-valuenow="${(rec.confidence * 100).toFixed(1)}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">ç½®ä¿¡åº¦: ${(rec.confidence * 100).toFixed(1)}%</small>
                    </div>
                </div>
            </div>
        `).join('')}

        <div class="alert alert-light mt-4">
            <p class="mb-0">
                <strong>èªªæ˜:</strong> æ¨è–¦åˆ†æ•¸åŸºæ–¼éŠæˆ²ç›¸ä¼¼æ€§ã€BGGè©•åˆ†å’Œæ’åè¨ˆç®—ã€‚
                ç½®ä¿¡åº¦è¡¨ç¤ºæ¨è–¦çš„å¯é ç¨‹åº¦ï¼Œåˆ†æ•¸è¶Šé«˜è¡¨ç¤ºè¶Šç¬¦åˆæ‚¨çš„åå¥½ã€‚
            </p>
        </div>
    `;
}

// æœå°‹å–®ä¸€éŠæˆ²ä¸¦ç²å–æ¨è–¦åˆ†æ•¸
async function getGameRecommendation(gameId, gameName) {
    try {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        const loadingHtml = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¨ˆç®—ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨è¨ˆç®—æ¨è–¦åˆ†æ•¸...</p>
            </div>
        `;

        // å‰µå»ºæˆ–æ›´æ–°æ¨è–¦çµæœå€åŸŸ
        let resultDiv = document.getElementById('game-recommendation-result');
        if (!resultDiv) {
            resultDiv = document.createElement('div');
            resultDiv.id = 'game-recommendation-result';
            resultDiv.className = 'card mt-4';
            document.querySelector('.container').appendChild(resultDiv);
        }

        resultDiv.innerHTML = loadingHtml;

        const response = await fetch('/api/rg/recommend-score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_id: gameId,
                game_name: gameName
            })
        });

        const data = await response.json();

        if (data.success) {
            displayGameRecommendationResult(data.result, gameName);
        } else {
            resultDiv.innerHTML = `
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">âŒ æ¨è–¦åˆ†æ•¸è¨ˆç®—å¤±æ•—</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger">${data.message}</p>
                    <button class="btn btn-outline-primary" onclick="searchGames(document.getElementById('game-search-input').value)">
                        é‡æ–°æœå°‹
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('ç²å–æ¨è–¦åˆ†æ•¸å¤±æ•—:', error);
        const resultDiv = document.getElementById('game-recommendation-result');
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">âŒ ç™¼ç”ŸéŒ¯èª¤</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger">ç²å–æ¨è–¦åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>
                </div>
            `;
        }
    }
}

// é¡¯ç¤ºéŠæˆ²æ¨è–¦åˆ†æ•¸çµæœ
function displayGameRecommendationResult(result, gameName) {
    const resultDiv = document.getElementById('game-recommendation-result');

    resultDiv.innerHTML = `
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ¯ ${gameName} æ¨è–¦åˆ†æ•¸</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>æ¨è–¦åˆ†æ•¸</h6>
                    <div class="display-4 text-primary">${result.score.toFixed(2)}</div>
                    <p class="text-muted">æ»¿åˆ† 10.0</p>
                </div>
                <div class="col-md-6">
                    <h6>è©³ç´°è³‡è¨Š</h6>
                    <ul class="list-unstyled">
                        <li><strong>éŠæˆ²åç¨±:</strong> ${gameName}</li>
                        <li><strong>BGG ID:</strong> ${result.game_id}</li>
                        <li><strong>æ¨è–¦åˆ†æ•¸:</strong> ${result.score.toFixed(2)}/10.0</li>
                        <li><strong>è¨ˆç®—æ™‚é–“:</strong> ${new Date().toLocaleString()}</li>
                    </ul>
                </div>
            </div>

            <div class="mt-3">
                <h6>åˆ†æ•¸èªªæ˜</h6>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar" role="progressbar"
                         style="width: ${(result.score / 10 * 100)}%"
                         aria-valuenow="${result.score}"
                         aria-valuemin="0"
                         aria-valuemax="10">
                        ${result.score.toFixed(2)}
                    </div>
                </div>
                <small class="text-muted">
                    æ¨è–¦åˆ†æ•¸åŸºæ–¼æ‚¨çš„æ”¶è—åå¥½ã€éŠæˆ²ç‰¹å¾µç›¸ä¼¼æ€§å’Œ BGG è©•åˆ†è¨ˆç®—
                </small>
            </div>

            <div class="mt-3">
                <button class="btn btn-outline-primary" onclick="searchGames(document.getElementById('game-search-input').value)">
                    æœå°‹å…¶ä»–éŠæˆ²
                </button>
                <button class="btn btn-outline-secondary" onclick="document.getElementById('game-recommendation-result').style.display='none'">
                    é—œé–‰
                </button>
            </div>
        </div>
    `;
}
</script>
{% endblock %}