{% extends "base.html" %}

{% block title %}遊戲推薦系統 - BGG 桌遊分析平台{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">🧠 個人化推薦系統</h2>
        </div>
        <div class="card-body">
            <!-- 算法選擇 -->
            {% if available_algorithms %}
            <div class="mb-4">
                <label class="form-label"><strong>推薦算法：</strong></label>
                <div class="btn-group" role="group">
                    {% for algo in available_algorithms %}
                    <a href="{{ url_for('recommendations', algorithm=algo.value) }}"
                       class="btn {% if current_algorithm == algo.value %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        {{ algo.name }}
                    </a>
                    {% endfor %}
                </div>
                <small class="form-text text-muted">
                    {% for algo in available_algorithms %}
                        {% if current_algorithm == algo.value %}{{ algo.description }}{% endif %}
                    {% endfor %}
                </small>
            </div>
            {% endif %}

            <!-- 單一遊戲打分說明 -->
            <div id="welcome-state" class="alert alert-info">
                先在下方搜尋一款桌遊，點選結果後，系統會用您的模型計算「該遊戲」的個人化推薦分數。
            </div>

            <!-- 遊戲搜尋 -->
            <div class="mb-3" style="position: relative;">
                <input type="text" id="game-search-input" class="form-control"
                       placeholder="搜尋桌遊名稱..." autocomplete="off">
                <div id="search-results" class="border rounded shadow-sm bg-white"
                     style="position: absolute; top: 100%; left: 0; right: 0; max-height: 300px; overflow-y: auto; z-index: 1000; display: none;">
                </div>
            </div>

            <!-- 不再顯示多遊戲清單或產生總表 -->
        </div>
    </div>

    <!-- 推薦結果 -->
    <div class="card" id="recommendations-section" style="display: none;">
        <div class="card-header bg-success text-white">
            <h2 class="mb-0">✨ 為您推薦</h2>
        </div>
        <div class="card-body">
            <div id="recommendations-content"></div>
        </div>
    </div>
</div>

<script>
let selectedGames = [];
let searchTimeout = null;

// 搜尋遊戲
document.getElementById('game-search-input').addEventListener('input', function(e) {
    const query = e.target.value.trim();

    clearTimeout(searchTimeout);

    if (query.length < 2) {
        hideSearchResults();
        return;
    }

    searchTimeout = setTimeout(() => {
        searchGames(query);
    }, 300);
});

// 點擊外部隱藏搜尋結果
document.addEventListener('click', function(e) {
    if (!e.target.closest('#game-search-input') && !e.target.closest('#search-results')) {
        hideSearchResults();
    }
});

async function searchGames(query) {
    try {
        // 使用真正的 BGG API 搜尋
        const response = await fetch('/api/bgg/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                exact: 10
            })
        });

        const data = await response.json();

        if (data.success) {
            displaySearchResults(data.results);
        } else {
            console.error('搜尋失敗:', data.message);
        }
    } catch (error) {
        console.error('搜尋錯誤:', error);
    }
}

function displaySearchResults(games) {
    const resultsDiv = document.getElementById('search-results');

    if (games.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-center text-muted">找不到相關遊戲</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.innerHTML = games.map(game => {
        return `
            <div class="p-2 border-bottom d-flex align-items-center" style="cursor: pointer;"
                 onclick="getGameRecommendation(${game.id}, '${game.name.replace(/'/g, "\'")}')">
                <img src="/static/images/default-game.png"
                     alt="${game.name}" class="me-2 rounded"
                     style="width: 40px; height: 40px; object-fit: cover;"
                     onerror="this.src='/static/images/default-game.png'">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${game.name}</h6>
                    <small class="text-muted">
                        BGG ID: ${game.id} |
                        年份: ${game.year || 'N/A'}
                    </small>
                </div>
                ${isSelected ? '<span class="text-success">✓ 已選擇</span>' : ''}
            </div>
        `;
    }).join('');

    resultsDiv.style.display = 'block';
}

function hideSearchResults() {
    document.getElementById('search-results').style.display = 'none';
}

// 取消多選邏輯，改由點擊即計分

function removeGame(objectid) {
    selectedGames = selectedGames.filter(game => game.objectid !== objectid);
    updateSelectedGamesDisplay();

    if (selectedGames.length === 0) {
        document.getElementById('welcome-state').style.display = 'block';
    }
}

function updateSelectedGamesDisplay() {
    const container = document.getElementById('selected-games');
    const recommendBtn = document.getElementById('recommend-btn');

    if (selectedGames.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                請搜尋並選擇您喜歡的桌遊（最多10款）
            </div>
        `;
        recommendBtn.disabled = true;
    } else {
        container.innerHTML = selectedGames.map(game => `
            <span class="badge bg-primary me-2 mb-2" style="font-size: 14px;">
                ${game.name}
                <button class="btn-close btn-close-white ms-2" style="font-size: 10px;"
                        onclick="removeGame(${game.objectid})" title="移除"></button>
            </span>
        `).join('');
        recommendBtn.disabled = false;
    }
}

async function getRecommendations() {
    const recommendBtn = document.getElementById('recommend-btn');
    const recommendationsSection = document.getElementById('recommendations-section');
    const recommendationsContent = document.getElementById('recommendations-content');

    if (selectedGames.length === 0) {
        alert('請先選擇至少一款遊戲');
        return;
    }

    // 顯示載入狀態
    recommendBtn.disabled = true;
    recommendBtn.textContent = '分析中...';

    recommendationsSection.style.display = 'block';
    recommendationsContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <p class="mt-2">正在分析您的偏好並生成推薦...</p>
        </div>
    `;

    try {
        const response = await fetch('/api/recommendations/by-games', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                games: selectedGames.map(game => game.objectid),
                num_recommendations: 10
            })
        });

        const data = await response.json();

        if (data.success) {
            displayRecommendations(data.recommendations, data.metadata || {});
        } else {
            recommendationsContent.innerHTML = `
                <div class="alert alert-danger">
                    推薦失敗: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('獲取推薦失敗:', error);
        recommendationsContent.innerHTML = `
            <div class="alert alert-danger">
                獲取推薦時發生錯誤，請稍後重試。
            </div>
        `;
    } finally {
        recommendBtn.disabled = false;
        recommendBtn.textContent = '重新推薦';
    }
}

function displayRecommendations(recommendations, metadata) {
    const content = document.getElementById('recommendations-content');

    if (recommendations.length === 0) {
        content.innerHTML = `
            <div class="text-center py-4">
                <div style="font-size: 48px; margin-bottom: 16px;">🤷‍♀️</div>
                <h3>暫無推薦</h3>
                <p>抱歉，根據您選擇的遊戲，我們暫時找不到合適的推薦</p>
            </div>
        `;
        return;
    }

    content.innerHTML = `
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">📊 推薦分析</h5>
            <p class="mb-0">
                基於您選擇的 ${selectedGames.length} 款遊戲${metadata.methods_used ? `，使用 ${metadata.methods_used.join(' + ')} 方法` : ''}，
                為您推薦 ${recommendations.length} 款高品質桌遊
            </p>
        </div>

        ${recommendations.map((rec, index) => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">${index + 1}. ${rec.name}</h5>
                        <span class="badge bg-success" style="font-size: 14px;">${rec.score}/10</span>
                    </div>
                    <div class="card-text">
                        <p class="mb-2">
                            <strong>BGG 評分:</strong> ${rec.rating ? rec.rating.toFixed(1) : 'N/A'} |
                            <strong>排名:</strong> ${rec.rank || 'N/A'} |
                            <strong>推薦方法:</strong> ${rec.method || rec.source}
                        </p>
                        ${rec.similarity ? `<p class="mb-2"><strong>相似度:</strong> ${(rec.similarity * 100).toFixed(1)}%</p>` : ''}
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar"
                                 style="width: ${(rec.confidence * 100).toFixed(1)}%"
                                 aria-valuenow="${(rec.confidence * 100).toFixed(1)}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">置信度: ${(rec.confidence * 100).toFixed(1)}%</small>
                    </div>
                </div>
            </div>
        `).join('')}

        <div class="alert alert-light mt-4">
            <p class="mb-0">
                <strong>說明:</strong> 推薦分數基於遊戲相似性、BGG評分和排名計算。
                置信度表示推薦的可靠程度，分數越高表示越符合您的偏好。
            </p>
        </div>
    `;
}

// 搜尋單一遊戲並獲取推薦分數
async function getGameRecommendation(gameId, gameName) {
    try {
        // 顯示載入狀態
        const loadingHtml = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">計算中...</span>
                </div>
                <p class="mt-2">正在計算推薦分數...</p>
            </div>
        `;

        // 創建或更新推薦結果區域
        let resultDiv = document.getElementById('game-recommendation-result');
        if (!resultDiv) {
            resultDiv = document.createElement('div');
            resultDiv.id = 'game-recommendation-result';
            resultDiv.className = 'card mt-4';
            document.querySelector('.container').appendChild(resultDiv);
        }

        resultDiv.innerHTML = loadingHtml;

        const response = await fetch('/api/rg/recommend-score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_id: gameId,
                game_name: gameName
            })
        });

        const data = await response.json();

        if (data.success) {
            displayGameRecommendationResult(data.result, gameName);
        } else {
            resultDiv.innerHTML = `
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">❌ 推薦分數計算失敗</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger">${data.message}</p>
                    <button class="btn btn-outline-primary" onclick="searchGames(document.getElementById('game-search-input').value)">
                        重新搜尋
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('獲取推薦分數失敗:', error);
        const resultDiv = document.getElementById('game-recommendation-result');
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">❌ 發生錯誤</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger">獲取推薦分數時發生錯誤，請稍後重試。</p>
                </div>
            `;
        }
    }
}

// 顯示遊戲推薦分數結果
function displayGameRecommendationResult(result, gameName) {
    const resultDiv = document.getElementById('game-recommendation-result');

    resultDiv.innerHTML = `
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">🎯 ${gameName} 推薦分數</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>推薦分數</h6>
                    <div class="display-4 text-primary">${result.score.toFixed(2)}</div>
                    <p class="text-muted">滿分 10.0</p>
                </div>
                <div class="col-md-6">
                    <h6>詳細資訊</h6>
                    <ul class="list-unstyled">
                        <li><strong>遊戲名稱:</strong> ${gameName}</li>
                        <li><strong>BGG ID:</strong> ${result.game_id}</li>
                        <li><strong>推薦分數:</strong> ${result.score.toFixed(2)}/10.0</li>
                        <li><strong>計算時間:</strong> ${new Date().toLocaleString()}</li>
                    </ul>
                </div>
            </div>

            <div class="mt-3">
                <h6>分數說明</h6>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar" role="progressbar"
                         style="width: ${(result.score / 10 * 100)}%"
                         aria-valuenow="${result.score}"
                         aria-valuemin="0"
                         aria-valuemax="10">
                        ${result.score.toFixed(2)}
                    </div>
                </div>
                <small class="text-muted">
                    推薦分數基於您的收藏偏好、遊戲特徵相似性和 BGG 評分計算
                </small>
            </div>

            <div class="mt-3">
                <button class="btn btn-outline-primary" onclick="searchGames(document.getElementById('game-search-input').value)">
                    搜尋其他遊戲
                </button>
                <button class="btn btn-outline-secondary" onclick="document.getElementById('game-recommendation-result').style.display='none'">
                    關閉
                </button>
            </div>
        </div>
    `;
}
</script>
{% endblock %}