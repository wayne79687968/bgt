{% extends "base.html" %}

{% block title %}è¨­å®š - BGG ç†±é–€éŠæˆ²å ±è¡¨{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>

    <!-- æ’ç¨‹è¨­å®š -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>â° æ’ç¨‹è¨­å®š</h5>
        </div>
        <div class="card-body">
            <form id="schedule-settings-form">
                <div class="mb-3">
                    <label class="form-label">
                        <strong>ğŸ• ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“</strong>
                    </label>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="schedule-hour" class="form-label">å°æ™‚</label>
                            <select class="form-select" id="schedule-hour" name="schedule_hour">
                                <!-- é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="schedule-minute" class="form-label">åˆ†é˜</label>
                            <select class="form-select" id="schedule-minute" name="schedule_minute">
                                <!-- é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="button" class="btn btn-primary" onclick="saveScheduleSettings()">
                                ğŸ’¾ å„²å­˜æ’ç¨‹è¨­å®š
                            </button>
                        </div>
                    </div>
                    <div class="form-text">
                        <strong>ğŸ“‹ æ’ç¨‹èªªæ˜ï¼š</strong><br>
                        â€¢ ç”±æ–¼ Zeabur å¹³å°é™åˆ¶ï¼Œæ’ç¨‹åŠŸèƒ½æ”¹ç”± GitHub Actions æä¾›<br>
                        â€¢ é è¨­æ¯æ—¥å°åŒ—æ™‚é–“ 07:00 åŸ·è¡Œï¼ˆUTC 23:00ï¼‰<br>
                        â€¢ æ™‚é–“è¨­å®šä¸»è¦ç”¨æ–¼è¨˜éŒ„å’Œé¡¯ç¤ºï¼Œå¯¦éš›åŸ·è¡Œæ™‚é–“éœ€åœ¨ GitHub Actions ä¸­èª¿æ•´<br>
                        â€¢ ä¹Ÿå¯é€éå¤–éƒ¨ Cron æœå‹™ï¼ˆå¦‚ cron-job.orgï¼‰å‘¼å« <code>/api/cron-trigger</code> ç«¯é»
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- å ±è¡¨ç”¢ç”Ÿè¨­å®š -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>âš™ï¸ å ±è¡¨ç”¢ç”Ÿè¨­å®š</h5>
        </div>
        <div class="card-body">
            <form id="report-settings-form">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="force-llm-analysis" name="force_llm_analysis">
                        <label class="form-check-label" for="force-llm-analysis">
                            <strong>ğŸ¤– å¼·åˆ¶é‡æ–°é€²è¡Œ LLM åˆ†æ</strong>
                        </label>
                        <div class="form-text">
                            å‹¾é¸æ­¤é¸é …å°‡é‡æ–°æŠ“å–è«–å£‡è¨è«–ä¸¦ä½¿ç”¨ LLM åˆ†ææ‰€æœ‰éŠæˆ²çš„ä¸Šæ¦œåŸå› ï¼Œè€Œä¸ä½¿ç”¨å¿«å–çš„åˆ†æçµæœã€‚
                            <br><small class="text-warning">âš ï¸ æ­¤é¸é …æœƒå¢åŠ åŸ·è¡Œæ™‚é–“å’Œ API ä½¿ç”¨é‡</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="force-regenerate" name="force_regenerate">
                        <label class="form-check-label" for="force-regenerate">
                            <strong>ğŸ”„ å¼·åˆ¶é‡æ–°ç”¢ç”Ÿå ±è¡¨</strong>
                        </label>
                        <div class="form-text">
                            å‹¾é¸æ­¤é¸é …å°‡å¼·åˆ¶é‡æ–°ç”¢ç”Ÿä»Šæ—¥å ±è¡¨ï¼Œå³ä½¿å·²å­˜åœ¨ä¹Ÿæœƒè¦†è“‹ã€‚
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ä»»å‹™ç‹€æ…‹é¡¯ç¤º -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“Š å ±è¡¨ç”¢ç”Ÿç‹€æ…‹</h5>
        </div>
        <div class="card-body">
            <div id="task-status" class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="status-text">æª¢æŸ¥ä¸­...</span>
                    <span id="status-time" class="text-muted"></span>
                </div>
                <div class="progress mt-2" style="height: 20px; display: none;" id="progress-bar-container">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="status-message" class="mt-2 text-muted" style="display: none;"></div>
            </div>

            <div class="d-flex gap-2">
                <button id="generate-btn" class="btn btn-success" onclick="generateReport()">
                    ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨
                </button>
                <button id="stop-btn" class="btn btn-danger" onclick="stopTask()" style="display: none;">
                    ğŸ›‘ åœæ­¢ä»»å‹™
                </button>
                <button class="btn btn-info" onclick="checkStatus()">
                    ğŸ“Š æª¢æŸ¥ç‹€æ…‹
                </button>
                <button class="btn btn-warning" onclick="checkFiles()">
                    ğŸ“„ æª¢æŸ¥å ±è¡¨æª”æ¡ˆ
                </button>
                <button class="btn btn-primary" onclick="checkDatabase()">
                    ğŸ—ƒï¸ æª¢æŸ¥è³‡æ–™åº«
                </button>
                <button class="btn btn-secondary" onclick="window.location.reload()">
                    ğŸ”„ é‡æ–°æ•´ç†é é¢
                </button>
            </div>
        </div>
    </div>

    <!-- å ±è¡¨æª”æ¡ˆåˆ—è¡¨ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“„ ç¾æœ‰å ±è¡¨æª”æ¡ˆ</h5>
        </div>
        <div class="card-body">
            {% if available_dates %}
                <div class="row">
                    {% for date in available_dates[:10] %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <a href="{{ url_for('index', date=date) }}" class="btn btn-outline-primary btn-sm">
                            ğŸ“… {{ date }}{% if loop.first %} (æœ€æ–°){% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% if available_dates|length > 10 %}
                    <p class="text-muted mt-2">é‚„æœ‰ {{ available_dates|length - 10 }} å€‹æ›´èˆŠçš„å ±è¡¨...</p>
                {% endif %}
            {% else %}
                <p class="text-muted">æš«ç„¡å ±è¡¨æª”æ¡ˆ</p>
            {% endif %}
        </div>
    </div>

    <!-- ç³»çµ±è³‡è¨Š -->
    <div class="card">
        <div class="card-header">
            <h5>ğŸ”§ ç³»çµ±è³‡è¨Š</h5>
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                <li><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>{{ last_updated }}</li>
                <li><strong>å ±è¡¨ç¸½æ•¸ï¼š</strong>{{ available_dates|length }}</li>
                <li><strong>ç³»çµ±ç‹€æ…‹ï¼š</strong><span class="text-success">æ­£å¸¸é‹è¡Œ</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
let statusCheckInterval = null;

function generateReport() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = 'â³ å•Ÿå‹•ä¸­...';

    // è®€å–è¨­å®šé¸é …
    const forceLlmAnalysis = document.getElementById('force-llm-analysis').checked;
    const forceRegenerate = document.getElementById('force-regenerate').checked;

    const requestBody = {
        force_llm_analysis: forceLlmAnalysis,
        force_regenerate: forceRegenerate
    };

    fetch('/api/run-scheduler', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            startStatusCheck();
        } else {
            showAlert('danger', data.message);
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
    });
}

function checkStatus() {
    fetch('/api/task-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        }
    })
    .catch(error => {
        console.error('Status check error:', error);
    });
}

function updateStatusDisplay(status) {
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-btn');
    const stopBtn = document.getElementById('stop-btn');

    if (status.is_running) {
        statusText.innerHTML = `ğŸ”„ ${status.current_step}`;
        statusTime.innerHTML = `é‹è¡Œæ™‚é–“: ${status.elapsed_minutes} åˆ†é˜`;

        progressContainer.style.display = 'block';
        progressBar.style.width = status.progress + '%';
        progressBar.innerHTML = status.progress + '%';

        statusMessage.style.display = 'block';
        statusMessage.innerHTML = status.message;

        generateBtn.disabled = true;
        generateBtn.innerHTML = 'â³ é‹è¡Œä¸­...';
        stopBtn.style.display = 'inline-block'; // é¡¯ç¤ºåœæ­¢æŒ‰éˆ•

        // å¦‚æœæ­£åœ¨é‹è¡Œï¼Œé–‹å§‹å®šæœŸæª¢æŸ¥
        if (!statusCheckInterval) {
            startStatusCheck();
        }
    } else {
        // æª¢æŸ¥æ˜¯å¦æ˜¯è¢«ç”¨æˆ¶åœæ­¢çš„ç‹€æ…‹
        if (status.current_step === 'å·²åœæ­¢' || status.message.includes('åœæ­¢')) {
            statusText.innerHTML = 'ğŸ›‘ ä»»å‹™å·²åœæ­¢';
            statusTime.innerHTML = status.elapsed_minutes ? `é‹è¡Œäº† ${status.elapsed_minutes} åˆ†é˜å¾Œåœæ­¢` : '';
        } else {
            statusText.innerHTML = 'â¸ï¸ ç„¡é‹è¡Œä¸­çš„ä»»å‹™';
            statusTime.innerHTML = '';
        }

        progressContainer.style.display = 'none';
        statusMessage.style.display = 'none';

        generateBtn.disabled = false;
        generateBtn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
        stopBtn.style.display = 'none'; // éš±è—åœæ­¢æŒ‰éˆ•

        // åœæ­¢ç‹€æ…‹æª¢æŸ¥
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }

        if (status.progress === 100) {
            showAlert('success', 'å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
        } else if (status.message && status.message.includes('å¤±æ•—')) {
            showAlert('danger', 'å ±è¡¨ç”¢ç”Ÿå¤±æ•—ï¼š' + status.message);
        } else if (status.current_step === 'å·²åœæ­¢') {
            showAlert('warning', 'ä»»å‹™å·²è¢«åœæ­¢');
        }
    }
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }

    statusCheckInterval = setInterval(checkStatus, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
    checkStatus(); // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
}

function stopTask() {
    const stopBtn = document.getElementById('stop-btn');
    const generateBtn = document.getElementById('generate-btn');
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    stopBtn.disabled = true;
    stopBtn.innerHTML = 'â³ åœæ­¢ä¸­...';

    fetch('/api/stop-task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            updateStatusDisplay({ is_running: false, current_step: 'å·²åœæ­¢', elapsed_minutes: 0, progress: 0, message: '' });
            stopBtn.disabled = false;
            stopBtn.innerHTML = 'ğŸ›‘ åœæ­¢ä»»å‹™';
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
            // åœæ­¢ç‹€æ…‹æª¢æŸ¥
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        } else {
            showAlert('danger', data.message);
            stopBtn.disabled = false;
            stopBtn.innerHTML = 'ğŸ›‘ åœæ­¢ä»»å‹™';
        }
    })
    .catch(error => {
        console.error('Error stopping task:', error);
        showAlert('danger', 'åœæ­¢ä»»å‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        stopBtn.disabled = false;
        stopBtn.innerHTML = 'ğŸ›‘ åœæ­¢ä»»å‹™';
    });
}

function checkFiles() {
    fetch('/api/check-files')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `ğŸ“‚ å ±è¡¨ç›®éŒ„: ${data.directory}\n`;
            message += `ğŸ“Š æª”æ¡ˆç¸½æ•¸: ${data.total_files}\n\n`;
            
            if (data.files.length > 0) {
                message += 'ğŸ“„ æª”æ¡ˆåˆ—è¡¨:\n';
                data.files.forEach(file => {
                    message += `â€¢ ${file.name} (${file.size} bytes, ${file.modified})\n`;
                });
            } else {
                message += 'æš«ç„¡å ±è¡¨æª”æ¡ˆ';
            }
            
            alert(message);
        } else {
            showAlert('danger', 'æª¢æŸ¥æª”æ¡ˆå¤±æ•—: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Check files error:', error);
        showAlert('danger', 'æª¢æŸ¥æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    });
}

function checkDatabase() {
    fetch('/api/check-database')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `ğŸ—ƒï¸ è³‡æ–™åº«é¡å‹: ${data.database_type}\n`;
            message += `ğŸ² éŠæˆ²è©³æƒ…ç¸½æ•¸: ${data.total_game_details}\n`;
            message += `ğŸ’¬ è«–å£‡è¨è«–ä¸²ç¸½æ•¸: ${data.total_forum_threads}\n\n`;
            
            message += 'ğŸ“Š ç†±é–€æ¦œå–®è¨˜éŒ„:\n';
            if (data.hot_games_by_date.length > 0) {
                data.hot_games_by_date.forEach(record => {
                    message += `â€¢ ${record.date}: ${record.count} å€‹éŠæˆ²\n`;
                });
            } else {
                message += 'æš«ç„¡ç†±é–€æ¦œå–®è¨˜éŒ„';
            }
            
            alert(message);
        } else {
            showAlert('danger', 'æª¢æŸ¥è³‡æ–™åº«å¤±æ•—: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Check database error:', error);
        showAlert('danger', 'æª¢æŸ¥è³‡æ–™åº«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // æ’å…¥åˆ°é é¢é ‚éƒ¨
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

function saveScheduleSettings() {
    const hour = document.getElementById('schedule-hour').value;
    const minute = document.getElementById('schedule-minute').value;
    
    if (!hour || !minute) {
        showAlert('warning', 'è«‹é¸æ“‡å°æ™‚å’Œåˆ†é˜');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'â³ å„²å­˜ä¸­...';
    
    fetch('/api/schedule-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hour: parseInt(hour),
            minute: parseInt(minute)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message);
        }
        btn.disabled = false;
        btn.innerHTML = 'ğŸ’¾ å„²å­˜æ’ç¨‹è¨­å®š';
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ’¾ å„²å­˜æ’ç¨‹è¨­å®š';
    });
}

function loadScheduleSettings() {
    fetch('/api/schedule-settings')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('schedule-hour').value = data.hour;
            document.getElementById('schedule-minute').value = data.minute;
        }
    })
    .catch(error => {
        console.error('Error loading schedule settings:', error);
    });
}

function initializeScheduleSelectors() {
    const hourSelect = document.getElementById('schedule-hour');
    const minuteSelect = document.getElementById('schedule-minute');
    
    // ç”Ÿæˆå°æ™‚é¸é … (0-23)
    for (let i = 0; i <= 23; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i.toString().padStart(2, '0');
        if (i === 23) option.selected = true; // é è¨­ 23:00
        hourSelect.appendChild(option);
    }
    
    // ç”Ÿæˆåˆ†é˜é¸é … (0-59)
    for (let i = 0; i <= 59; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i.toString().padStart(2, '0');
        if (i === 0) option.selected = true; // é è¨­ 00 åˆ†
        minuteSelect.appendChild(option);
    }
}

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    initializeScheduleSelectors();
    loadScheduleSettings();
    checkStatus();
});
</script>
{% endblock %}