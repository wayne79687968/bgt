{% extends "base.html" %}

{% block title %}è¨­å®š - BGG ç†±é–€éŠæˆ²å ±è¡¨{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>

    <!-- ä»»å‹™ç‹€æ…‹é¡¯ç¤º -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“Š å ±è¡¨ç”¢ç”Ÿç‹€æ…‹</h5>
        </div>
        <div class="card-body">
            <div id="task-status" class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="status-text">æª¢æŸ¥ä¸­...</span>
                    <span id="status-time" class="text-muted"></span>
                </div>
                <div class="progress mt-2" style="height: 20px; display: none;" id="progress-bar-container">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="status-message" class="mt-2 text-muted" style="display: none;"></div>
            </div>

            <div class="d-flex gap-2">
                <button id="generate-btn" class="btn btn-success" onclick="generateReport()">
                    ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨
                </button>
                <button class="btn btn-info" onclick="checkStatus()">
                    ğŸ“Š æª¢æŸ¥ç‹€æ…‹
                </button>
                <button class="btn btn-secondary" onclick="window.location.reload()">
                    ğŸ”„ é‡æ–°æ•´ç†é é¢
                </button>
            </div>
        </div>
    </div>

    <!-- å ±è¡¨æª”æ¡ˆåˆ—è¡¨ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“„ ç¾æœ‰å ±è¡¨æª”æ¡ˆ</h5>
        </div>
        <div class="card-body">
            {% if available_dates %}
                <div class="row">
                    {% for date in available_dates[:10] %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <a href="{{ url_for('index', date=date) }}" class="btn btn-outline-primary btn-sm">
                            ğŸ“… {{ date }}{% if loop.first %} (æœ€æ–°){% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% if available_dates|length > 10 %}
                    <p class="text-muted mt-2">é‚„æœ‰ {{ available_dates|length - 10 }} å€‹æ›´èˆŠçš„å ±è¡¨...</p>
                {% endif %}
            {% else %}
                <p class="text-muted">æš«ç„¡å ±è¡¨æª”æ¡ˆ</p>
            {% endif %}
        </div>
    </div>

    <!-- ç³»çµ±è³‡è¨Š -->
    <div class="card">
        <div class="card-header">
            <h5>ğŸ”§ ç³»çµ±è³‡è¨Š</h5>
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                <li><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>{{ last_updated }}</li>
                <li><strong>å ±è¡¨ç¸½æ•¸ï¼š</strong>{{ available_dates|length }}</li>
                <li><strong>ç³»çµ±ç‹€æ…‹ï¼š</strong><span class="text-success">æ­£å¸¸é‹è¡Œ</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
let statusCheckInterval = null;

function generateReport() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = 'â³ å•Ÿå‹•ä¸­...';

    fetch('/api/run-scheduler', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            startStatusCheck();
        } else {
            showAlert('danger', data.message);
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
    });
}

function checkStatus() {
    fetch('/api/task-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        }
    })
    .catch(error => {
        console.error('Status check error:', error);
    });
}

function updateStatusDisplay(status) {
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-btn');

    if (status.is_running) {
        statusText.innerHTML = `ğŸ”„ ${status.current_step}`;
        statusTime.innerHTML = `é‹è¡Œæ™‚é–“: ${status.elapsed_minutes} åˆ†é˜`;

        progressContainer.style.display = 'block';
        progressBar.style.width = status.progress + '%';
        progressBar.innerHTML = status.progress + '%';

        statusMessage.style.display = 'block';
        statusMessage.innerHTML = status.message;

        generateBtn.disabled = true;
        generateBtn.innerHTML = 'â³ é‹è¡Œä¸­...';

        // å¦‚æœæ­£åœ¨é‹è¡Œï¼Œé–‹å§‹å®šæœŸæª¢æŸ¥
        if (!statusCheckInterval) {
            startStatusCheck();
        }
    } else {
        statusText.innerHTML = 'â¸ï¸ ç„¡é‹è¡Œä¸­çš„ä»»å‹™';
        statusTime.innerHTML = '';
        progressContainer.style.display = 'none';
        statusMessage.style.display = 'none';

        generateBtn.disabled = false;
        generateBtn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';

        // åœæ­¢ç‹€æ…‹æª¢æŸ¥
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }

        if (status.progress === 100) {
            showAlert('success', 'å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
        } else if (status.message && status.message.includes('å¤±æ•—')) {
            showAlert('danger', 'å ±è¡¨ç”¢ç”Ÿå¤±æ•—ï¼š' + status.message);
        }
    }
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }

    statusCheckInterval = setInterval(checkStatus, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
    checkStatus(); // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // æ’å…¥åˆ°é é¢é ‚éƒ¨
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    checkStatus();
});
</script>
{% endblock %}