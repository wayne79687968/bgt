{% extends "base.html" %}

{% block title %}è¨­å®š - BGG ç†±é–€éŠæˆ²å ±è¡¨{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>

    <!-- ç”¨æˆ¶è³‡è¨Š -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ‘¤ å¸³è™Ÿè³‡è¨Š</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto">
                    {% if user.picture %}
                    <img src="{{ user.picture }}" alt="ç”¨æˆ¶é ­åƒ" class="rounded-circle" style="width: 48px; height: 48px;">
                    {% else %}
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="col">
                    <h6 class="mb-1">{{ user.name or 'æœªè¨­å®šå§“å' }}</h6>
                    <p class="mb-0 text-muted">
                        <i class="fas fa-envelope"></i> {{ user.email }}
                    </p>
                    <div class="mt-1">
                        {% if user.has_full_access %}
                        <span class="badge bg-success">
                            <i class="fas fa-crown"></i> å®Œæ•´æ¬Šé™
                        </span>
                        {% else %}
                        <span class="badge bg-info">
                            <i class="fas fa-eye"></i> æª¢è¦–æ¬Šé™
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-auto">
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                    </a>
                </div>
            </div>
            <hr>
            <div class="small text-muted">
                <strong>å¯ç”¨åŠŸèƒ½ï¼š</strong>
                <ul class="mb-0 mt-1">
                    <li>ğŸ“Š ç†±é–€éŠæˆ²å ±è¡¨æª¢è¦–</li>
                    <li>ğŸ¯ å€‹äººåŒ–éŠæˆ²æ¨è–¦</li>
                    {% if user.has_full_access %}
                    <li class="text-success">ğŸ¨ è¨­è¨ˆå¸«/ç¹ªå¸«è¿½è¹¤</li>
                    <li class="text-success">âš™ï¸ ç³»çµ±ç®¡ç†åŠŸèƒ½</li>
                    {% else %}
                    <li class="text-muted">ğŸ”’ è¨­è¨ˆå¸«è¿½è¹¤ (éœ€è¦å®Œæ•´æ¬Šé™)</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Email é€šçŸ¥èªªæ˜ -->
    {% if user.has_full_access %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“§ Email é€šçŸ¥</h5>
        </div>
        <div class="card-body">
            <p class="mb-2">
                <i class="fas fa-check-circle text-success"></i> 
                æ‚¨çš„ Email åœ°å€å·²è¨­å®šç‚ºï¼š<strong>{{ user.email }}</strong>
            </p>
            <div class="form-text">
                ç•¶æ‚¨è¿½è¹¤çš„è¨­è¨ˆå¸«/ç¹ªå¸«æœ‰æ–°ä½œå“ç™¼å¸ƒæ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼é€é€šçŸ¥åˆ°æ­¤ Email åœ°å€ã€‚
                <br><small class="text-info">ğŸ’¡ Email åœ°å€ä¾†è‡ªæ‚¨çš„ Google å¸³è™Ÿï¼Œç„¡æ³•åœ¨æ­¤ä¿®æ”¹</small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- BGG ä½¿ç”¨è€…è¨­å®š -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ§‘â€ğŸ’» BGG å¸³è™Ÿè¨­å®š</h5>
        </div>
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <label for="bgg-username" class="col-form-label">BGG Username</label>
                </div>
                <div class="col-auto">
                    <input type="text" id="bgg-username" class="form-control" placeholder="your-bgg-id" value="{{ bgg_username }}">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ å„²å­˜</button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-success" onclick="syncCollection()">ğŸ” åŒæ­¥æ”¶è—</button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-warning" onclick="updateCollection()">ğŸ”„ æ›´æ–°æ”¶è—</button>
                </div>
                <div class="col-auto">
                    <a class="btn btn-outline-secondary" href="{{ url_for('recommendations') }}">âœ¨ æŸ¥çœ‹æ¨è–¦</a>
                </div>
            </div>
            <div class="form-text mt-2">
                å…ˆè¼¸å…¥ BGG ä½¿ç”¨è€…åç¨±ä¸¦å„²å­˜ï¼Œå†é»é¸ã€ŒåŒæ­¥æ”¶è—ã€å°‡ä½ çš„æ”¶è—æ“·å–åˆ°æœ¬ç³»çµ±ï¼ˆå«åŸºæœ¬è©•åˆ†èˆ‡é¡˜æœ›æ¸…å–®å„ªå…ˆç´šï¼‰ã€‚
            </div>
        </div>
    </div>

    <!-- RG æ¨¡å‹èˆ‡è³‡æ–™è¨­å®šï¼ˆå›ºå®šé è¨­ï¼Œåƒ…é¡¯ç¤ºï¼‰ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ§  RG æ¨¡å‹èˆ‡è³‡æ–™ï¼ˆå›ºå®šé è¨­ï¼‰</h5>
        </div>
        <div class="card-body">
            <ul class="mb-2">
                <li>æ¨¡å‹è¼¸å‡ºç›®éŒ„ï¼š<code>{{ rg_model_dir }}</code></li>
                <li>Games è³‡æ–™æª”ï¼š<code>{{ rg_games_file }}</code></li>
                <li>Ratings è³‡æ–™æª”ï¼š<code>{{ rg_ratings_file }}</code></li>
            </ul>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="trainRgModel()">ğŸ§ª è¨“ç·´æ¨¡å‹</button>
                <button class="btn btn-info" onclick="checkRgStatus()">ğŸ” æª¢æŸ¥ RG ç‹€æ…‹</button>
                <a class="btn btn-outline-secondary" href="https://gitlab.com/recommend.games/board-game-scraper" target="_blank" rel="noopener noreferrer">ğŸ“¦ å–å¾—è³‡æ–™ï¼ˆScraperï¼‰</a>
                <a class="btn btn-outline-secondary" href="https://gitlab.com/recommend.games/board-game-recommender" target="_blank" rel="noopener noreferrer">ğŸ“š Recommender æ–‡ä»¶</a>
            </div>
            <div class="form-text mt-2">
                ä¾æ“šå®˜æ–¹èªªæ˜ï¼Œè³‡æ–™æ ¼å¼ç‚º JSON Linesï¼ˆ.jlï¼‰ã€‚å¯ç”¨ Scraper ç”¢å‡º `bgg_GameItem.jl` å’Œ `bgg_RatingItem.jl`ï¼Œå†ç”¨ RG è¨“ç·´ã€‚è©³è¦‹æ–‡ä»¶ã€‚
            </div>
        </div>
    </div>

    <!-- RG è³‡æ–™æŠ“å–ï¼ˆScraperï¼‰ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“¦ RG è³‡æ–™æŠ“å–ï¼ˆScraperï¼‰</h5>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <div class="form-text">æŒ‰ä¸€ä¸‹å³å¯ä½¿ç”¨é è¨­æŒ‡ä»¤æŠ“å–è³‡æ–™ï¼ˆè¼¸å‡ºè·¯å¾‘å›ºå®šç‚º <code>{{ rg_games_file }}</code> èˆ‡ <code>{{ rg_ratings_file }}</code>ï¼‰ã€‚</div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="startRgScrapeOneClick()">â–¶ï¸ ä¸€éµæŠ“å–</button>
                <button class="btn btn-info" onclick="pollRgTask()">ğŸ” æª¢æŸ¥æŠ“å–ç‹€æ…‹</button>
            </div>
            <pre id="rg-task-log" class="mt-3" style="max-height: 240px; overflow: auto; background: #f8f9fa; padding: 10px; border-radius: 6px;"></pre>
        </div>
    </div>

    <!-- æ’ç¨‹è¨­å®š -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>â° æ’ç¨‹è¨­å®š</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>ğŸ“‹ æ’ç¨‹èªªæ˜ï¼š</strong><br>
                â€¢ å ±è¡¨æ’ç¨‹ç”± GitHub Actions è‡ªå‹•åŸ·è¡Œ<br>
                â€¢ é è¨­æ¯æ—¥å°åŒ—æ™‚é–“ 07:00 åŸ·è¡Œï¼ˆUTC 23:00ï¼‰<br>
                â€¢ è¦ä¿®æ”¹åŸ·è¡Œæ™‚é–“ï¼Œè«‹åœ¨ GitHub Repository çš„ Settings â†’ Secrets and variables â†’ Actions ä¸­è¨­å®š <code>CRON_SCHEDULE</code><br>
                â€¢ ä¹Ÿå¯é€éå¤–éƒ¨ Cron æœå‹™ï¼ˆå¦‚ cron-job.orgï¼‰å‘¼å« <code>/api/cron-trigger</code> ç«¯é»
            </div>
        </div>
    </div>

    <!-- å ±è¡¨ç”¢ç”Ÿè¨­å®š -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>âš™ï¸ å ±è¡¨ç”¢ç”Ÿè¨­å®š</h5>
        </div>
        <div class="card-body">
            <form id="report-settings-form">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="force-llm-analysis" name="force_llm_analysis">
                        <label class="form-check-label" for="force-llm-analysis">
                            <strong>ğŸ¤– å¼·åˆ¶é‡æ–°é€²è¡Œ LLM åˆ†æ</strong>
                        </label>
                        <div class="form-text">
                            å‹¾é¸æ­¤é¸é …å°‡é‡æ–°æŠ“å–è«–å£‡è¨è«–ä¸¦ä½¿ç”¨ LLM åˆ†ææ‰€æœ‰éŠæˆ²çš„ä¸Šæ¦œåŸå› ï¼Œè€Œä¸ä½¿ç”¨å¿«å–çš„åˆ†æçµæœã€‚
                            <br><small class="text-warning">âš ï¸ æ­¤é¸é …æœƒå¢åŠ åŸ·è¡Œæ™‚é–“å’Œ API ä½¿ç”¨é‡</small>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="force-regenerate" name="force_regenerate">
                        <label class="form-check-label" for="force-regenerate">
                            <strong>ğŸ”„ å¼·åˆ¶é‡æ–°ç”¢ç”Ÿå ±è¡¨</strong>
                        </label>
                        <div class="form-text">
                            å‹¾é¸æ­¤é¸é …å°‡å¼·åˆ¶é‡æ–°ç”¢ç”Ÿä»Šæ—¥å ±è¡¨ï¼Œå³ä½¿å·²å­˜åœ¨ä¹Ÿæœƒè¦†è“‹ã€‚
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ä»»å‹™ç‹€æ…‹é¡¯ç¤º -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“Š å ±è¡¨ç”¢ç”Ÿç‹€æ…‹</h5>
        </div>
        <div class="card-body">
            <div id="task-status" class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="status-text">æª¢æŸ¥ä¸­...</span>
                    <span id="status-time" class="text-muted"></span>
                </div>
                <div class="progress mt-2" style="height: 20px; display: none;" id="progress-bar-container">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="status-message" class="mt-2 text-muted" style="display: none;"></div>
            </div>

            <div class="d-flex gap-2">
                <button id="generate-btn" class="btn btn-success" onclick="generateReport()">
                    ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨
                </button>
                <button id="stop-btn" class="btn btn-danger" onclick="stopTask()" style="display: none;">
                    ğŸ›‘ åœæ­¢ä»»å‹™
                </button>
                <button class="btn btn-info" onclick="checkStatus()">
                    ğŸ“Š æª¢æŸ¥ç‹€æ…‹
                </button>
                <button class="btn btn-warning" onclick="checkFiles()">
                    ğŸ“„ æª¢æŸ¥å ±è¡¨æª”æ¡ˆ
                </button>
                <button class="btn btn-primary" onclick="checkDatabase()">
                    ğŸ—ƒï¸ æª¢æŸ¥è³‡æ–™åº«
                </button>
                <button class="btn btn-secondary" onclick="window.location.reload()">
                    ğŸ”„ é‡æ–°æ•´ç†é é¢
                </button>
            </div>
        </div>
    </div>

    <!-- å ±è¡¨æª”æ¡ˆåˆ—è¡¨ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ“„ ç¾æœ‰å ±è¡¨æª”æ¡ˆ</h5>
        </div>
        <div class="card-body">
            {% if available_dates %}
                <div class="row">
                    {% for date in available_dates[:10] %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <a href="{{ url_for('index', date=date) }}" class="btn btn-outline-primary btn-sm">
                            ğŸ“… {{ date }}{% if loop.first %} (æœ€æ–°){% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% if available_dates|length > 10 %}
                    <p class="text-muted mt-2">é‚„æœ‰ {{ available_dates|length - 10 }} å€‹æ›´èˆŠçš„å ±è¡¨...</p>
                {% endif %}
            {% else %}
                <p class="text-muted">æš«ç„¡å ±è¡¨æª”æ¡ˆ</p>
            {% endif %}
        </div>
    </div>

    <!-- ç³»çµ±è³‡è¨Š -->
    <div class="card">
        <div class="card-header">
            <h5>ğŸ”§ ç³»çµ±è³‡è¨Š</h5>
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                <li><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>{{ last_updated }}</li>
                <li><strong>å ±è¡¨ç¸½æ•¸ï¼š</strong>{{ available_dates|length }}</li>
                <li><strong>ç³»çµ±ç‹€æ…‹ï¼š</strong><span class="text-success">æ­£å¸¸é‹è¡Œ</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
function saveUserEmail() {
    const email = document.getElementById('user-email').value.trim();
    if (!email) {
        showAlert('danger', 'è«‹è¼¸å…¥ Email åœ°å€');
        return;
    }
    
    // ç°¡å–®çš„ email æ ¼å¼é©—è­‰
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAlert('danger', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€');
        return;
    }
    
    fetch('/api/save-user-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message || 'Email å„²å­˜å¤±æ•—');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', 'Email å„²å­˜å¤±æ•—');
    });
}

function saveSettings() {
    const username = document.getElementById('bgg-username').value.trim();
    if (!username) {
        showAlert('danger', 'è«‹è¼¸å…¥ BGG ä½¿ç”¨è€…åç¨±');
        return;
    }
    fetch('/api/save-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bgg_username: username })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message || 'å„²å­˜å¤±æ•—');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', 'å„²å­˜å¤±æ•—');
    });
}

function startRgScrapeOneClick() {
    fetch('/api/rg-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
            pollRgTask();
        } else {
            showAlert('danger', data.message || 'å•Ÿå‹•å¤±æ•—');
        }
    }).catch(() => showAlert('danger', 'å•Ÿå‹•å¤±æ•—'));
}

let rgTaskTimer = null;
function pollRgTask() {
    if (rgTaskTimer) clearInterval(rgTaskTimer);
    const logEl = document.getElementById('rg-task-log');
    const tick = () => {
        fetch('/api/rg-task-status')
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;
                const s = data.status;
                const lines = [];
                lines.push(`ç‹€æ…‹ï¼š${s.is_running ? 'é‹è¡Œä¸­' : 'å·²åœæ­¢'}  é€²åº¦ï¼š${s.progress}%  ç”¨æ™‚ï¼š${s.elapsed_seconds}s`);
                if (s.message) lines.push(`è¨Šæ¯ï¼š${s.message}`);
                if (s.stdout_tail && s.stdout_tail.length) {
                    lines.push('--- stdout ---');
                    lines.push(...s.stdout_tail);
                }
                if (s.stderr_tail && s.stderr_tail.length) {
                    lines.push('--- stderr ---');
                    lines.push(...s.stderr_tail);
                }
                logEl.textContent = lines.join('\n');
                logEl.scrollTop = logEl.scrollHeight;
                if (!s.is_running) clearInterval(rgTaskTimer);
            })
            .catch(() => {});
    };
    tick();
    rgTaskTimer = setInterval(tick, 2000);
}

function trainRgModel() {
    fetch('/api/rg-train', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'è¨“ç·´å®Œæˆ');
                if (data.stdout) console.log(data.stdout);
            } else {
                showAlert('danger', data.message || 'è¨“ç·´å¤±æ•—');
            }
        })
        .catch(err => {
            console.error(err);
            showAlert('danger', 'è¨“ç·´å¤±æ•—');
        });
}

function checkRgStatus() {
    fetch('/api/rg-status')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showAlert('danger', data.message || 'æª¢æŸ¥å¤±æ•—');
                return;
            }
            const s = data.status;
            const msg = `RG_API_URL: ${s.rg_api_url || '(æœªè¨­å®š)'}\n` +
                        `æ¨¡å‹ç›®éŒ„: ${s.rg_model_dir} (${s.model_dir_exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'})\n` +
                        `Games æª”: ${s.rg_games_file} (${s.games_file_exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'})\n` +
                        `Ratings æª”: ${s.rg_ratings_file} (${s.ratings_file_exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'})`;
            alert(msg);
        })
        .catch(() => showAlert('danger', 'æª¢æŸ¥å¤±æ•—'));
}

function syncCollection() {
    fetch('/api/sync-collection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message || 'åŒæ­¥å¤±æ•—');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', 'åŒæ­¥å¤±æ•—');
    });
}

function updateCollection() {
    if (!confirm('ç¢ºå®šè¦é‡æ–°åŒæ­¥æ”¶è—ä¸¦é‡æ–°è¨“ç·´æ¨è–¦æ¨¡å‹å—ï¼Ÿé€™å°‡æœƒè¦†è“‹ç¾æœ‰çš„æ¨¡å‹ã€‚')) {
        return;
    }
    
    const username = document.getElementById('bgg-username').value.trim();
    if (!username) {
        showAlert('warning', 'è«‹å…ˆè¨­å®š BGG ç”¨æˆ¶å');
        return;
    }
    
    showAlert('info', 'é–‹å§‹æ›´æ–°æ”¶è—å’Œé‡æ–°è¨“ç·´æ¨¡å‹ï¼Œè«‹ç¨å€™...');
    
    // è§¸ç™¼é‡æ–°åŒæ­¥å’Œè¨“ç·´
    fetch('/api/rg-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', 'æ”¶è—æ›´æ–°å·²é–‹å§‹ï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“');
        } else {
            showAlert('danger', data.message || 'æ›´æ–°å¤±æ•—');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', 'æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤');
    });
}
let statusCheckInterval = null;

function generateReport() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = 'â³ å•Ÿå‹•ä¸­...';

    // è®€å–è¨­å®šé¸é …
    const forceLlmAnalysis = document.getElementById('force-llm-analysis').checked;
    const forceRegenerate = document.getElementById('force-regenerate').checked;

    const requestBody = {
        force_llm_analysis: forceLlmAnalysis,
        force_regenerate: forceRegenerate
    };

    fetch('/api/run-scheduler', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            startStatusCheck();
        } else {
            showAlert('danger', data.message);
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
    });
}

function checkStatus() {
    fetch('/api/task-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        }
    })
    .catch(error => {
        console.error('Status check error:', error);
    });
}

function updateStatusDisplay(status) {
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-btn');
    const stopBtn = document.getElementById('stop-btn');

    if (status.is_running) {
        statusText.innerHTML = `ğŸ”„ ${status.current_step}`;
        statusTime.innerHTML = `é‹è¡Œæ™‚é–“: ${status.elapsed_minutes} åˆ†é˜`;

        progressContainer.style.display = 'block';
        progressBar.style.width = status.progress + '%';
        progressBar.innerHTML = status.progress + '%';

        statusMessage.style.display = 'block';
        statusMessage.innerHTML = status.message;

        generateBtn.disabled = true;
        generateBtn.innerHTML = 'â³ é‹è¡Œä¸­...';
        stopBtn.style.display = 'inline-block'; // é¡¯ç¤ºåœæ­¢æŒ‰éˆ•

        // å¦‚æœæ­£åœ¨é‹è¡Œï¼Œé–‹å§‹å®šæœŸæª¢æŸ¥
        if (!statusCheckInterval) {
            startStatusCheck();
        }
    } else {
        // æª¢æŸ¥æ˜¯å¦æ˜¯è¢«ç”¨æˆ¶åœæ­¢çš„ç‹€æ…‹
        if (status.current_step === 'å·²åœæ­¢' || status.message.includes('åœæ­¢')) {
            statusText.innerHTML = 'ğŸ›‘ ä»»å‹™å·²åœæ­¢';
            statusTime.innerHTML = status.elapsed_minutes ? `é‹è¡Œäº† ${status.elapsed_minutes} åˆ†é˜å¾Œåœæ­¢` : '';
        } else {
            statusText.innerHTML = 'â¸ï¸ ç„¡é‹è¡Œä¸­çš„ä»»å‹™';
            statusTime.innerHTML = '';
        }

        progressContainer.style.display = 'none';
        statusMessage.style.display = 'none';

        generateBtn.disabled = false;
        generateBtn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
        stopBtn.style.display = 'none'; // éš±è—åœæ­¢æŒ‰éˆ•

        // åœæ­¢ç‹€æ…‹æª¢æŸ¥
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }

        if (status.progress === 100) {
            showAlert('success', 'å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
        } else if (status.message && status.message.includes('å¤±æ•—')) {
            showAlert('danger', 'å ±è¡¨ç”¢ç”Ÿå¤±æ•—ï¼š' + status.message);
        } else if (status.current_step === 'å·²åœæ­¢') {
            showAlert('warning', 'ä»»å‹™å·²è¢«åœæ­¢');
        }
    }
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }

    statusCheckInterval = setInterval(checkStatus, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
    checkStatus(); // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
}

function stopTask() {
    const stopBtn = document.getElementById('stop-btn');
    const generateBtn = document.getElementById('generate-btn');
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    stopBtn.disabled = true;
    stopBtn.innerHTML = 'â³ åœæ­¢ä¸­...';

    fetch('/api/stop-task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            updateStatusDisplay({ is_running: false, current_step: 'å·²åœæ­¢', elapsed_minutes: 0, progress: 0, message: '' });
            stopBtn.disabled = false;
            stopBtn.innerHTML = 'ğŸ›‘ åœæ­¢ä»»å‹™';
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'ğŸ”„ é‡æ–°ç”¢ç”Ÿå ±è¡¨';
            // åœæ­¢ç‹€æ…‹æª¢æŸ¥
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        } else {
            showAlert('danger', data.message);
            stopBtn.disabled = false;
            stopBtn.innerHTML = 'ğŸ›‘ åœæ­¢ä»»å‹™';
        }
    })
    .catch(error => {
        console.error('Error stopping task:', error);
        showAlert('danger', 'åœæ­¢ä»»å‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        stopBtn.disabled = false;
        stopBtn.innerHTML = 'ğŸ›‘ åœæ­¢ä»»å‹™';
    });
}

function checkFiles() {
    fetch('/api/check-files')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `ğŸ“‚ å ±è¡¨ç›®éŒ„: ${data.directory}\n`;
            message += `ğŸ“Š æª”æ¡ˆç¸½æ•¸: ${data.total_files}\n\n`;

            if (data.files.length > 0) {
                message += 'ğŸ“„ æª”æ¡ˆåˆ—è¡¨:\n';
                data.files.forEach(file => {
                    message += `â€¢ ${file.name} (${file.size} bytes, ${file.modified})\n`;
                });
            } else {
                message += 'æš«ç„¡å ±è¡¨æª”æ¡ˆ';
            }

            alert(message);
        } else {
            showAlert('danger', 'æª¢æŸ¥æª”æ¡ˆå¤±æ•—: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Check files error:', error);
        showAlert('danger', 'æª¢æŸ¥æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    });
}

function checkDatabase() {
    fetch('/api/check-database')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `ğŸ—ƒï¸ è³‡æ–™åº«é¡å‹: ${data.database_type}\n`;
            message += `ğŸ² éŠæˆ²è©³æƒ…ç¸½æ•¸: ${data.total_game_details}\n`;
            message += `ğŸ’¬ è«–å£‡è¨è«–ä¸²ç¸½æ•¸: ${data.total_forum_threads}\n\n`;

            message += 'ğŸ“Š ç†±é–€æ¦œå–®è¨˜éŒ„:\n';
            if (data.hot_games_by_date.length > 0) {
                data.hot_games_by_date.forEach(record => {
                    message += `â€¢ ${record.date}: ${record.count} å€‹éŠæˆ²\n`;
                });
            } else {
                message += 'æš«ç„¡ç†±é–€æ¦œå–®è¨˜éŒ„';
            }

            alert(message);
        } else {
            showAlert('danger', 'æª¢æŸ¥è³‡æ–™åº«å¤±æ•—: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Check database error:', error);
        showAlert('danger', 'æª¢æŸ¥è³‡æ–™åº«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // æ’å…¥åˆ°é é¢é ‚éƒ¨
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}


// é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    checkStatus();
});
</script>
{% endblock %}