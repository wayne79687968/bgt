{% extends "base.html" %}

{% block title %}設定 - BGG 熱門遊戲報表{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>⚙️ 系統設定</h2>

    <!-- 任務狀態顯示 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>📊 報表產生狀態</h5>
        </div>
        <div class="card-body">
            <div id="task-status" class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="status-text">檢查中...</span>
                    <span id="status-time" class="text-muted"></span>
                </div>
                <div class="progress mt-2" style="height: 20px; display: none;" id="progress-bar-container">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="status-message" class="mt-2 text-muted" style="display: none;"></div>
            </div>

            <div class="d-flex gap-2">
                <button id="generate-btn" class="btn btn-success" onclick="generateReport()">
                    🔄 重新產生報表
                </button>
                <button class="btn btn-info" onclick="checkStatus()">
                    📊 檢查狀態
                </button>
                <button class="btn btn-secondary" onclick="window.location.reload()">
                    🔄 重新整理頁面
                </button>
            </div>
        </div>
    </div>

    <!-- 報表檔案列表 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>📄 現有報表檔案</h5>
        </div>
        <div class="card-body">
            {% if available_dates %}
                <div class="row">
                    {% for date in available_dates[:10] %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <a href="{{ url_for('index', date=date) }}" class="btn btn-outline-primary btn-sm">
                            📅 {{ date }}{% if loop.first %} (最新){% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% if available_dates|length > 10 %}
                    <p class="text-muted mt-2">還有 {{ available_dates|length - 10 }} 個更舊的報表...</p>
                {% endif %}
            {% else %}
                <p class="text-muted">暫無報表檔案</p>
            {% endif %}
        </div>
    </div>

    <!-- 系統資訊 -->
    <div class="card">
        <div class="card-header">
            <h5>🔧 系統資訊</h5>
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                <li><strong>最後更新：</strong>{{ last_updated }}</li>
                <li><strong>報表總數：</strong>{{ available_dates|length }}</li>
                <li><strong>系統狀態：</strong><span class="text-success">正常運行</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
let statusCheckInterval = null;

function generateReport() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '⏳ 啟動中...';

    fetch('/api/run-scheduler', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            startStatusCheck();
        } else {
            showAlert('danger', data.message);
            btn.disabled = false;
            btn.innerHTML = '🔄 重新產生報表';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '請求失敗，請稍後再試');
        btn.disabled = false;
        btn.innerHTML = '🔄 重新產生報表';
    });
}

function checkStatus() {
    fetch('/api/task-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        }
    })
    .catch(error => {
        console.error('Status check error:', error);
    });
}

function updateStatusDisplay(status) {
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-btn');

    if (status.is_running) {
        statusText.innerHTML = `🔄 ${status.current_step}`;
        statusTime.innerHTML = `運行時間: ${status.elapsed_minutes} 分鐘`;

        progressContainer.style.display = 'block';
        progressBar.style.width = status.progress + '%';
        progressBar.innerHTML = status.progress + '%';

        statusMessage.style.display = 'block';
        statusMessage.innerHTML = status.message;

        generateBtn.disabled = true;
        generateBtn.innerHTML = '⏳ 運行中...';

        // 如果正在運行，開始定期檢查
        if (!statusCheckInterval) {
            startStatusCheck();
        }
    } else {
        statusText.innerHTML = '⏸️ 無運行中的任務';
        statusTime.innerHTML = '';
        progressContainer.style.display = 'none';
        statusMessage.style.display = 'none';

        generateBtn.disabled = false;
        generateBtn.innerHTML = '🔄 重新產生報表';

        // 停止狀態檢查
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }

        if (status.progress === 100) {
            showAlert('success', '報表產生完成！');
        } else if (status.message && status.message.includes('失敗')) {
            showAlert('danger', '報表產生失敗：' + status.message);
        }
    }
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }

    statusCheckInterval = setInterval(checkStatus, 5000); // 每5秒檢查一次
    checkStatus(); // 立即檢查一次
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // 插入到頁面頂部
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // 3秒後自動消失
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// 頁面載入時檢查狀態
document.addEventListener('DOMContentLoaded', function() {
    checkStatus();
});
</script>
{% endblock %}