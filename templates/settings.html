{% extends "base.html" %}

{% block title %}設定 - BGG 熱門遊戲報表{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>⚙️ 系統設定</h2>

    <!-- 用戶資訊 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>👤 帳號資訊</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto">
                    {% if user.picture %}
                    <img src="{{ user.picture }}" alt="用戶頭像" class="rounded-circle" style="width: 48px; height: 48px;">
                    {% else %}
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="col">
                    <h6 class="mb-1">{{ user.name or '未設定姓名' }}</h6>
                    <p class="mb-0 text-muted">
                        <i class="fas fa-envelope"></i> {{ user.email }}
                    </p>
                    <div class="mt-1">
                        {% if user.has_full_access %}
                        <span class="badge bg-success">
                            <i class="fas fa-crown"></i> 完整權限
                        </span>
                        {% else %}
                        <span class="badge bg-info">
                            <i class="fas fa-eye"></i> 檢視權限
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-auto">
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt"></i> 登出
                    </a>
                </div>
            </div>
            <hr>
            <div class="small text-muted">
                <strong>可用功能：</strong>
                <ul class="mb-0 mt-1">
                    <li>📊 熱門遊戲報表檢視</li>
                    <li>🎯 個人化遊戲推薦</li>
                    {% if user.has_full_access %}
                    <li class="text-success">🎨 設計師/繪師追蹤</li>
                    <li class="text-success">⚙️ 系統管理功能</li>
                    {% else %}
                    <li class="text-muted">🔒 設計師追蹤 (需要完整權限)</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Email 通知說明 -->
    {% if user.has_full_access %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>📧 Email 通知</h5>
        </div>
        <div class="card-body">
            <p class="mb-2">
                <i class="fas fa-check-circle text-success"></i> 
                您的 Email 地址已設定為：<strong>{{ user.email }}</strong>
            </p>
            <div class="form-text">
                當您追蹤的設計師/繪師有新作品發布時，系統會自動發送通知到此 Email 地址。
                <br><small class="text-info">💡 Email 地址來自您的 Google 帳號，無法在此修改</small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- BGG 使用者設定 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>🧑‍💻 BGG 帳號設定</h5>
        </div>
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <label for="bgg-username" class="col-form-label">BGG Username</label>
                </div>
                <div class="col-auto">
                    <input type="text" id="bgg-username" class="form-control" placeholder="your-bgg-id" value="{{ bgg_username }}">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="saveSettings()">💾 儲存</button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-success" onclick="syncCollection()">🔁 同步收藏</button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-warning" onclick="updateCollection()">🔄 更新收藏</button>
                </div>
                <div class="col-auto">
                    <a class="btn btn-outline-secondary" href="{{ url_for('recommendations') }}">✨ 查看推薦</a>
                </div>
            </div>
            <div class="form-text mt-2">
                先輸入 BGG 使用者名稱並儲存，再點選「同步收藏」將你的收藏擷取到本系統（含基本評分與願望清單優先級）。
            </div>
        </div>
    </div>

    <!-- RG 模型與資料設定（固定預設，僅顯示） -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>🧠 RG 模型與資料（固定預設）</h5>
        </div>
        <div class="card-body">
            <ul class="mb-2">
                <li>模型輸出目錄：<code>{{ rg_model_dir }}</code></li>
                <li>Games 資料檔：<code>{{ rg_games_file }}</code></li>
                <li>Ratings 資料檔：<code>{{ rg_ratings_file }}</code></li>
            </ul>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="trainRgModel()">🧪 訓練模型</button>
                <button class="btn btn-info" onclick="checkRgStatus()">🔍 檢查 RG 狀態</button>
                <a class="btn btn-outline-secondary" href="https://gitlab.com/recommend.games/board-game-scraper" target="_blank" rel="noopener noreferrer">📦 取得資料（Scraper）</a>
                <a class="btn btn-outline-secondary" href="https://gitlab.com/recommend.games/board-game-recommender" target="_blank" rel="noopener noreferrer">📚 Recommender 文件</a>
            </div>
            <div class="form-text mt-2">
                依據官方說明，資料格式為 JSON Lines（.jl）。可用 Scraper 產出 `bgg_GameItem.jl` 和 `bgg_RatingItem.jl`，再用 RG 訓練。詳見文件。
            </div>
        </div>
    </div>

    <!-- RG 資料抓取（Scraper） -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>📦 RG 資料抓取（Scraper）</h5>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <div class="form-text">按一下即可使用預設指令抓取資料（輸出路徑固定為 <code>{{ rg_games_file }}</code> 與 <code>{{ rg_ratings_file }}</code>）。</div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="startRgScrapeOneClick()">▶️ 一鍵抓取</button>
                <button class="btn btn-info" onclick="pollRgTask()">🔎 檢查抓取狀態</button>
            </div>
            <pre id="rg-task-log" class="mt-3" style="max-height: 240px; overflow: auto; background: #f8f9fa; padding: 10px; border-radius: 6px;"></pre>
        </div>
    </div>

    <!-- 排程設定 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>⏰ 排程設定</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>📋 排程說明：</strong><br>
                • 報表排程由 GitHub Actions 自動執行<br>
                • 預設每日台北時間 07:00 執行（UTC 23:00）<br>
                • 要修改執行時間，請在 GitHub Repository 的 Settings → Secrets and variables → Actions 中設定 <code>CRON_SCHEDULE</code><br>
                • 也可透過外部 Cron 服務（如 cron-job.org）呼叫 <code>/api/cron-trigger</code> 端點
            </div>
        </div>
    </div>

    <!-- 報表產生設定 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>⚙️ 報表產生設定</h5>
        </div>
        <div class="card-body">
            <form id="report-settings-form">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="force-llm-analysis" name="force_llm_analysis">
                        <label class="form-check-label" for="force-llm-analysis">
                            <strong>🤖 強制重新進行 LLM 分析</strong>
                        </label>
                        <div class="form-text">
                            勾選此選項將重新抓取論壇討論並使用 LLM 分析所有遊戲的上榜原因，而不使用快取的分析結果。
                            <br><small class="text-warning">⚠️ 此選項會增加執行時間和 API 使用量</small>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="force-regenerate" name="force_regenerate">
                        <label class="form-check-label" for="force-regenerate">
                            <strong>🔄 強制重新產生報表</strong>
                        </label>
                        <div class="form-text">
                            勾選此選項將強制重新產生今日報表，即使已存在也會覆蓋。
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 任務狀態顯示 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>📊 報表產生狀態</h5>
        </div>
        <div class="card-body">
            <div id="task-status" class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="status-text">檢查中...</span>
                    <span id="status-time" class="text-muted"></span>
                </div>
                <div class="progress mt-2" style="height: 20px; display: none;" id="progress-bar-container">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="status-message" class="mt-2 text-muted" style="display: none;"></div>
            </div>

            <div class="d-flex gap-2">
                <button id="generate-btn" class="btn btn-success" onclick="generateReport()">
                    🔄 重新產生報表
                </button>
                <button id="stop-btn" class="btn btn-danger" onclick="stopTask()" style="display: none;">
                    🛑 停止任務
                </button>
                <button class="btn btn-info" onclick="checkStatus()">
                    📊 檢查狀態
                </button>
                <button class="btn btn-warning" onclick="checkFiles()">
                    📄 檢查報表檔案
                </button>
                <button class="btn btn-primary" onclick="checkDatabase()">
                    🗃️ 檢查資料庫
                </button>
                <button class="btn btn-secondary" onclick="window.location.reload()">
                    🔄 重新整理頁面
                </button>
            </div>
        </div>
    </div>

    <!-- 報表檔案列表 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>📄 現有報表檔案</h5>
        </div>
        <div class="card-body">
            {% if available_dates %}
                <div class="row">
                    {% for date in available_dates[:10] %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <a href="{{ url_for('index', date=date) }}" class="btn btn-outline-primary btn-sm">
                            📅 {{ date }}{% if loop.first %} (最新){% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% if available_dates|length > 10 %}
                    <p class="text-muted mt-2">還有 {{ available_dates|length - 10 }} 個更舊的報表...</p>
                {% endif %}
            {% else %}
                <p class="text-muted">暫無報表檔案</p>
            {% endif %}
        </div>
    </div>

    <!-- 系統資訊 -->
    <div class="card">
        <div class="card-header">
            <h5>🔧 系統資訊</h5>
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                <li><strong>最後更新：</strong>{{ last_updated }}</li>
                <li><strong>報表總數：</strong>{{ available_dates|length }}</li>
                <li><strong>系統狀態：</strong><span class="text-success">正常運行</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
function saveUserEmail() {
    const email = document.getElementById('user-email').value.trim();
    if (!email) {
        showAlert('danger', '請輸入 Email 地址');
        return;
    }
    
    // 簡單的 email 格式驗證
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAlert('danger', '請輸入有效的 Email 地址');
        return;
    }
    
    fetch('/api/save-user-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message || 'Email 儲存失敗');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', 'Email 儲存失敗');
    });
}

function saveSettings() {
    const username = document.getElementById('bgg-username').value.trim();
    if (!username) {
        showAlert('danger', '請輸入 BGG 使用者名稱');
        return;
    }
    fetch('/api/save-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bgg_username: username })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message || '儲存失敗');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', '儲存失敗');
    });
}

function startRgScrapeOneClick() {
    fetch('/api/rg-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
            pollRgTask();
        } else {
            showAlert('danger', data.message || '啟動失敗');
        }
    }).catch(() => showAlert('danger', '啟動失敗'));
}

let rgTaskTimer = null;
function pollRgTask() {
    if (rgTaskTimer) clearInterval(rgTaskTimer);
    const logEl = document.getElementById('rg-task-log');
    const tick = () => {
        fetch('/api/rg-task-status')
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;
                const s = data.status;
                const lines = [];
                lines.push(`狀態：${s.is_running ? '運行中' : '已停止'}  進度：${s.progress}%  用時：${s.elapsed_seconds}s`);
                if (s.message) lines.push(`訊息：${s.message}`);
                if (s.stdout_tail && s.stdout_tail.length) {
                    lines.push('--- stdout ---');
                    lines.push(...s.stdout_tail);
                }
                if (s.stderr_tail && s.stderr_tail.length) {
                    lines.push('--- stderr ---');
                    lines.push(...s.stderr_tail);
                }
                logEl.textContent = lines.join('\n');
                logEl.scrollTop = logEl.scrollHeight;
                if (!s.is_running) clearInterval(rgTaskTimer);
            })
            .catch(() => {});
    };
    tick();
    rgTaskTimer = setInterval(tick, 2000);
}

function trainRgModel() {
    fetch('/api/rg-train', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('success', '訓練完成');
                if (data.stdout) console.log(data.stdout);
            } else {
                showAlert('danger', data.message || '訓練失敗');
            }
        })
        .catch(err => {
            console.error(err);
            showAlert('danger', '訓練失敗');
        });
}

function checkRgStatus() {
    fetch('/api/rg-status')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showAlert('danger', data.message || '檢查失敗');
                return;
            }
            const s = data.status;
            const msg = `RG_API_URL: ${s.rg_api_url || '(未設定)'}\n` +
                        `模型目錄: ${s.rg_model_dir} (${s.model_dir_exists ? '存在' : '不存在'})\n` +
                        `Games 檔: ${s.rg_games_file} (${s.games_file_exists ? '存在' : '不存在'})\n` +
                        `Ratings 檔: ${s.rg_ratings_file} (${s.ratings_file_exists ? '存在' : '不存在'})`;
            alert(msg);
        })
        .catch(() => showAlert('danger', '檢查失敗'));
}

function syncCollection() {
    fetch('/api/sync-collection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message || '同步失敗');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', '同步失敗');
    });
}

function updateCollection() {
    if (!confirm('確定要重新同步收藏並重新訓練推薦模型嗎？這將會覆蓋現有的模型。')) {
        return;
    }
    
    const username = document.getElementById('bgg-username').value.trim();
    if (!username) {
        showAlert('warning', '請先設定 BGG 用戶名');
        return;
    }
    
    showAlert('info', '開始更新收藏和重新訓練模型，請稍候...');
    
    // 觸發重新同步和訓練
    fetch('/api/rg-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(data => {
        if (data.success) {
            showAlert('success', '收藏更新已開始，這可能需要幾分鐘時間');
        } else {
            showAlert('danger', data.message || '更新失敗');
        }
    }).catch(err => {
        console.error(err);
        showAlert('danger', '更新時發生錯誤');
    });
}
let statusCheckInterval = null;

function generateReport() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '⏳ 啟動中...';

    // 讀取設定選項
    const forceLlmAnalysis = document.getElementById('force-llm-analysis').checked;
    const forceRegenerate = document.getElementById('force-regenerate').checked;

    const requestBody = {
        force_llm_analysis: forceLlmAnalysis,
        force_regenerate: forceRegenerate
    };

    fetch('/api/run-scheduler', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            startStatusCheck();
        } else {
            showAlert('danger', data.message);
            btn.disabled = false;
            btn.innerHTML = '🔄 重新產生報表';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '請求失敗，請稍後再試');
        btn.disabled = false;
        btn.innerHTML = '🔄 重新產生報表';
    });
}

function checkStatus() {
    fetch('/api/task-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        }
    })
    .catch(error => {
        console.error('Status check error:', error);
    });
}

function updateStatusDisplay(status) {
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-btn');
    const stopBtn = document.getElementById('stop-btn');

    if (status.is_running) {
        statusText.innerHTML = `🔄 ${status.current_step}`;
        statusTime.innerHTML = `運行時間: ${status.elapsed_minutes} 分鐘`;

        progressContainer.style.display = 'block';
        progressBar.style.width = status.progress + '%';
        progressBar.innerHTML = status.progress + '%';

        statusMessage.style.display = 'block';
        statusMessage.innerHTML = status.message;

        generateBtn.disabled = true;
        generateBtn.innerHTML = '⏳ 運行中...';
        stopBtn.style.display = 'inline-block'; // 顯示停止按鈕

        // 如果正在運行，開始定期檢查
        if (!statusCheckInterval) {
            startStatusCheck();
        }
    } else {
        // 檢查是否是被用戶停止的狀態
        if (status.current_step === '已停止' || status.message.includes('停止')) {
            statusText.innerHTML = '🛑 任務已停止';
            statusTime.innerHTML = status.elapsed_minutes ? `運行了 ${status.elapsed_minutes} 分鐘後停止` : '';
        } else {
            statusText.innerHTML = '⏸️ 無運行中的任務';
            statusTime.innerHTML = '';
        }

        progressContainer.style.display = 'none';
        statusMessage.style.display = 'none';

        generateBtn.disabled = false;
        generateBtn.innerHTML = '🔄 重新產生報表';
        stopBtn.style.display = 'none'; // 隱藏停止按鈕

        // 停止狀態檢查
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }

        if (status.progress === 100) {
            showAlert('success', '報表產生完成！');
        } else if (status.message && status.message.includes('失敗')) {
            showAlert('danger', '報表產生失敗：' + status.message);
        } else if (status.current_step === '已停止') {
            showAlert('warning', '任務已被停止');
        }
    }
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }

    statusCheckInterval = setInterval(checkStatus, 5000); // 每5秒檢查一次
    checkStatus(); // 立即檢查一次
}

function stopTask() {
    const stopBtn = document.getElementById('stop-btn');
    const generateBtn = document.getElementById('generate-btn');
    const statusText = document.getElementById('status-text');
    const statusTime = document.getElementById('status-time');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    stopBtn.disabled = true;
    stopBtn.innerHTML = '⏳ 停止中...';

    fetch('/api/stop-task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            updateStatusDisplay({ is_running: false, current_step: '已停止', elapsed_minutes: 0, progress: 0, message: '' });
            stopBtn.disabled = false;
            stopBtn.innerHTML = '🛑 停止任務';
            generateBtn.disabled = false;
            generateBtn.innerHTML = '🔄 重新產生報表';
            // 停止狀態檢查
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        } else {
            showAlert('danger', data.message);
            stopBtn.disabled = false;
            stopBtn.innerHTML = '🛑 停止任務';
        }
    })
    .catch(error => {
        console.error('Error stopping task:', error);
        showAlert('danger', '停止任務失敗，請稍後再試');
        stopBtn.disabled = false;
        stopBtn.innerHTML = '🛑 停止任務';
    });
}

function checkFiles() {
    fetch('/api/check-files')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `📂 報表目錄: ${data.directory}\n`;
            message += `📊 檔案總數: ${data.total_files}\n\n`;

            if (data.files.length > 0) {
                message += '📄 檔案列表:\n';
                data.files.forEach(file => {
                    message += `• ${file.name} (${file.size} bytes, ${file.modified})\n`;
                });
            } else {
                message += '暫無報表檔案';
            }

            alert(message);
        } else {
            showAlert('danger', '檢查檔案失敗: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Check files error:', error);
        showAlert('danger', '檢查檔案失敗，請稍後再試');
    });
}

function checkDatabase() {
    fetch('/api/check-database')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `🗃️ 資料庫類型: ${data.database_type}\n`;
            message += `🎲 遊戲詳情總數: ${data.total_game_details}\n`;
            message += `💬 論壇討論串總數: ${data.total_forum_threads}\n\n`;

            message += '📊 熱門榜單記錄:\n';
            if (data.hot_games_by_date.length > 0) {
                data.hot_games_by_date.forEach(record => {
                    message += `• ${record.date}: ${record.count} 個遊戲\n`;
                });
            } else {
                message += '暫無熱門榜單記錄';
            }

            alert(message);
        } else {
            showAlert('danger', '檢查資料庫失敗: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Check database error:', error);
        showAlert('danger', '檢查資料庫失敗，請稍後再試');
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // 插入到頁面頂部
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // 3秒後自動消失
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}


// 頁面載入時檢查狀態
document.addEventListener('DOMContentLoaded', function() {
    checkStatus();
});
</script>
{% endblock %}