{% extends "base.html" %}

{% block title %}ç™»å…¥ - BGG ç¶œåˆåˆ†æå¹³å°{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-4">
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <h2 class="card-title mb-3">ğŸ² BGG åˆ†æå¹³å°</h2>
                        <p class="text-muted">è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ</p>
                    </div>
                    
                    <!-- ç™»å…¥è¡¨å–® -->
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email åœ°å€</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">å¯†ç¢¼</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
                                <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
                                ç™»å…¥
                            </button>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <!-- è¨»å†Šå’Œå¿˜è¨˜å¯†ç¢¼é€£çµ -->
                    <div class="text-center">
                        <p class="mb-2">
                            <small>é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="{{ url_for('register') }}">ç«‹å³è¨»å†Š</a></small>
                        </p>
                        <p>
                            <small><a href="{{ url_for('forgot_password') }}">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a></small>
                        </p>
                    </div>
                    
                    <!-- æˆ–åˆ†éš”ç·š -->
                    <div class="text-center my-3">
                        <small class="text-muted">æˆ–ä½¿ç”¨é©—è­‰ç¢¼ç™»å…¥</small>
                    </div>
                    
                    <!-- é©—è­‰ç¢¼ç™»å…¥è¡¨å–® -->
                    <form id="codeLoginForm">
                        <div class="mb-3">
                            <label for="codeEmail" class="form-label">Email åœ°å€</label>
                            <input type="email" class="form-control" id="codeEmail" name="email" required>
                        </div>
                        <div class="d-grid mb-3">
                            <button type="button" class="btn btn-outline-secondary" id="sendCodeBtn">
                                <span class="spinner-border spinner-border-sm d-none" id="sendCodeSpinner"></span>
                                ç™¼é€é©—è­‰ç¢¼
                            </button>
                        </div>
                        <div class="mb-3 d-none" id="codeInputGroup">
                            <label for="verifyCode" class="form-label">é©—è­‰ç¢¼</label>
                            <input type="text" class="form-control" id="verifyCode" name="code" maxlength="6" placeholder="è«‹è¼¸å…¥6ä½æ•¸é©—è­‰ç¢¼">
                            <div class="form-text">é©—è­‰ç¢¼å°‡åœ¨10åˆ†é˜å¾Œå¤±æ•ˆ</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg d-none" id="verifyLoginBtn">
                                <span class="spinner-border spinner-border-sm d-none" id="verifySpinner"></span>
                                é©—è­‰ç™»å…¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">ç³»çµ±é€šçŸ¥</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const codeLoginForm = document.getElementById('codeLoginForm');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyLoginBtn = document.getElementById('verifyLoginBtn');
    
    // é¡¯ç¤ºé€šçŸ¥
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        
        toastMessage.textContent = message;
        toast.className = `toast ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : ''}`;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    // ä¸€èˆ¬ç™»å…¥
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const loginBtn = document.getElementById('loginBtn');
        const loginSpinner = document.getElementById('loginSpinner');
        
        loginBtn.disabled = true;
        loginSpinner.classList.remove('d-none');
        
        try {
            const formData = new FormData(loginForm);
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: formData.get('email'),
                    password: formData.get('password')
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('ç™»å…¥æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...', 'success');
                setTimeout(() => {
                    window.location.href = result.redirect || '/dashboard';
                }, 1000);
            } else {
                showToast(result.message || 'ç™»å…¥å¤±æ•—', 'error');
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        } finally {
            loginBtn.disabled = false;
            loginSpinner.classList.add('d-none');
        }
    });
    
    // ç™¼é€é©—è­‰ç¢¼
    sendCodeBtn.addEventListener('click', async function() {
        const email = document.getElementById('codeEmail').value;
        if (!email) {
            showToast('è«‹è¼¸å…¥ Email åœ°å€', 'error');
            return;
        }
        
        const sendCodeSpinner = document.getElementById('sendCodeSpinner');
        sendCodeBtn.disabled = true;
        sendCodeSpinner.classList.remove('d-none');
        
        try {
            const response = await fetch('/auth/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    type: 'login'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±', 'success');
                document.getElementById('codeInputGroup').classList.remove('d-none');
                document.getElementById('verifyLoginBtn').classList.remove('d-none');
                
                // å€’æ•¸è¨ˆæ™‚
                let countdown = 60;
                sendCodeBtn.textContent = `é‡æ–°ç™¼é€ (${countdown})`;
                const timer = setInterval(() => {
                    countdown--;
                    sendCodeBtn.textContent = `é‡æ–°ç™¼é€ (${countdown})`;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        sendCodeBtn.textContent = 'ç™¼é€é©—è­‰ç¢¼';
                        sendCodeBtn.disabled = false;
                    }
                }, 1000);
            } else {
                showToast(result.message || 'ç™¼é€å¤±æ•—', 'error');
                sendCodeBtn.disabled = false;
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            sendCodeBtn.disabled = false;
        } finally {
            sendCodeSpinner.classList.add('d-none');
        }
    });
    
    // é©—è­‰ç¢¼ç™»å…¥
    codeLoginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('codeEmail').value;
        const code = document.getElementById('verifyCode').value;
        
        if (!code) {
            showToast('è«‹è¼¸å…¥é©—è­‰ç¢¼', 'error');
            return;
        }
        
        const verifySpinner = document.getElementById('verifySpinner');
        verifyLoginBtn.disabled = true;
        verifySpinner.classList.remove('d-none');
        
        try {
            const response = await fetch('/auth/verify-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    code: code
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('é©—è­‰æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...', 'success');
                setTimeout(() => {
                    window.location.href = result.redirect || '/dashboard';
                }, 1000);
            } else {
                showToast(result.message || 'é©—è­‰å¤±æ•—', 'error');
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        } finally {
            verifyLoginBtn.disabled = false;
            verifySpinner.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}