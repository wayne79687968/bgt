{% extends "base.html" %}

{% block title %}BGG 推薦 - 簡化版{% endblock %}

{% block head %}
<style>
/* 簡潔的 Google Search 風格 */
.search-container {
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.search-logo {
    font-size: 3rem;
    margin-bottom: 2rem;
    font-weight: 300;
    color: #333;
}

.search-box {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin-bottom: 2rem;
}

.search-input {
    width: 100%;
    height: 50px;
    border: 2px solid #ddd;
    border-radius: 25px;
    padding: 0 50px 0 20px;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.search-input:focus {
    border-color: #4285f4;
    box-shadow: 0 4px 20px rgba(66,133,244,0.2);
}

.search-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: #4285f4;
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.search-btn:hover {
    background: #3367d6;
    transform: translateY(-50%) scale(1.05);
}

/* 搜尋結果浮窗 */
.search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: none;
}

.search-popup {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 90vw;
    width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}

.search-result-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
    margin-bottom: 10px;
}

.search-result-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.recommendation-score {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.score-high { background: #28a745; }
.score-medium { background: #ffc107; }
.score-low { background: #dc3545; }

.close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.user-info {
    position: fixed;
    top: 80px;
    right: 20px;
    color: #666;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 12px;
    border-radius: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
}

.alert-info {
    margin: 2rem auto;
    max-width: 600px;
    text-align: left;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 使用者資訊 -->
    <div class="user-info">
        BGG 使用者：<strong>{{ bgg_username or '未設定' }}</strong>
    </div>

    <!-- Google Search 風格的主介面 -->
    <div class="search-container">
        <div class="search-logo">🎲 BGG 遊戲推薦</div>

        <div class="search-box">
            <input type="text" class="search-input" id="gameSearchInput"
                   placeholder="搜尋桌遊名稱，獲取推薦分數..."
                   onkeypress="if(event.key=='Enter') searchGames()">
            <button class="search-btn" onclick="searchGames()">🔍</button>
        </div>

        {% if not bgg_username %}
        <div class="alert alert-warning">
            <h5>⚠️ 需要設定 BGG 用戶名</h5>
            <p>請先設定您的 BGG 用戶名並同步收藏才能使用推薦功能</p>
            <a href="{{ url_for('settings') }}" class="btn btn-primary">前往設定</a>
        </div>
        {% endif %}
    </div>

    <!-- 搜尋結果浮窗 -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-popup">
            <button class="close-btn" onclick="closeSearchResults()">×</button>
            <h4>🎲 遊戲搜尋結果</h4>
            <div id="searchResultsList">
                <!-- 搜尋結果將在這裡顯示 -->
            </div>
        </div>
    </div>

    <script>
    async function searchGames() {
        const query = document.getElementById('gameSearchInput').value.trim();

        if (!query) {
            showNotification('請輸入搜尋關鍵字', 'warning');
            return;
        }

        // 顯示載入動畫
        const searchBtn = document.querySelector('.search-btn');
        const originalContent = searchBtn.innerHTML;
        searchBtn.innerHTML = '⏳';

        try {
            const response = await fetch('/api/bgg/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query, exact: false })
            });

            const data = await response.json();

            if (data.success) {
                displaySearchResults(data.results);
            } else {
                showNotification('搜尋失敗: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('搜尋錯誤:', error);
            showNotification('搜尋時發生錯誤', 'error');
        } finally {
            searchBtn.innerHTML = originalContent;
        }
    }

    function displaySearchResults(results) {
        const searchResultsList = document.getElementById('searchResultsList');

        if (results.length === 0) {
            searchResultsList.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">沒有找到相關遊戲</p>
                    <small>試試調整搜尋關鍵字</small>
                </div>
            `;
        } else {
            let html = '';
            results.forEach((game, index) => {
                html += `
                    <div class="search-result-item" onclick="getGameRecommendation('${game.id}', '${game.name}')" style="animation-delay: ${index * 0.05}s">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${game.name}</h6>
                                <small class="text-muted">${game.year ? '發行年份: ' + game.year : 'BGG ID: ' + game.id}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-light text-dark">${game.id}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-primary">點擊獲取推薦分數 →</small>
                        </div>
                    </div>
                `;
            });
            searchResultsList.innerHTML = html;
        }

        // 顯示搜尋結果浮窗
        const overlay = document.getElementById('searchOverlay');
        overlay.style.display = 'block';
    }

    async function getGameRecommendation(gameId, gameName) {
        try {
            // 顯示載入狀態
            const loadingHtml = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">計算中...</span>
                    </div>
                    <p class="mt-2">正在計算推薦分數...</p>
                </div>
            `;
            document.getElementById('searchResultsList').innerHTML = loadingHtml;

            const response = await fetch('/api/rg/recommend-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    game_id: gameId,
                    game_name: gameName
                })
            });

            const data = await response.json();

            if (data.success) {
                displayRecommendationResult(data.result);
            } else {
                showNotification('獲取推薦分數失敗: ' + data.message, 'error');
                searchGames(); // 重新顯示搜尋結果
            }
        } catch (error) {
            console.error('推薦分數計算錯誤:', error);
            showNotification('計算推薦分數時發生錯誤', 'error');
        }
    }

    function displayRecommendationResult(result) {
        // 根據分數等級選擇樣式
        let scoreClass = 'score-medium';
        if (result.score_level === 'excellent' || result.score_level === 'very_good') {
            scoreClass = 'score-high';
        } else if (result.score_level === 'poor') {
            scoreClass = 'score-low';
        }

        const html = `
            <div class="text-center py-4">
                <div class="mb-3">
                    <h5>${result.name}</h5>
                    ${result.year ? `<small class="text-muted">(${result.year})</small>` : ''}
                </div>

                <div class="mb-4">
                    <div class="mb-2">
                        <span class="recommendation-score ${scoreClass}">
                            ${result.score ? result.score.toFixed(2) : 'N/A'} / ${result.max_score || 10} 分
                        </span>
                    </div>
                    ${result.score_description ? `
                        <div class="mb-2">
                            <small class="fw-bold text-${scoreClass === 'score-high' ? 'success' : scoreClass === 'score-low' ? 'danger' : 'warning'}">
                                ${result.score_description}
                            </small>
                        </div>
                    ` : ''}
                </div>

                ${result.details ? `
                    <div class="mb-3">
                        <small class="text-muted">${result.details}</small>
                    </div>
                ` : ''}

                <div class="d-flex gap-2 justify-content-center">
                    <a href="https://boardgamegeek.com/boardgame/${result.game_id}" target="_blank" class="btn btn-outline-primary btn-sm">
                        在 BGG 查看
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="searchGames()">
                        ← 返回搜尋
                    </button>
                </div>
            </div>
        `;

        document.getElementById('searchResultsList').innerHTML = html;
    }

    function closeSearchResults() {
        document.getElementById('searchOverlay').style.display = 'none';
    }

    function showNotification(message, type = 'info') {
        // 創建通知元素
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        // 3秒後自動移除
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 3000);
    }
    </script>

    <div class="mt-3 text-center">
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">⚙️ 前往設定</a>
        <a href="{{ url_for('recommendations') }}" class="btn btn-outline-secondary">✨ 內建推薦</a>
    </div>
</div>
{% endblock %}