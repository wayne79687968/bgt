{% extends "base.html" %}

{% block title %}RG 推薦 - BGG 熱門遊戲報表{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>🧠 進階智能推薦</h2>
    <p class="text-muted">BGG 使用者：<strong>{{ bgg_username or '未設定' }}</strong></p>

    <!-- 算法選擇器 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <label for="algorithmSelect" class="form-label">🎯 選擇推薦算法：</label>
            <select class="form-select" id="algorithmSelect" onchange="changeAlgorithm()">
                {% for algo in available_algorithms %}
                <option value="{{ algo.value }}" {% if algo.value == current_algorithm %}selected{% endif %}>
                    {{ algo.name }}
                </option>
                {% endfor %}
            </select>
            <small class="form-text text-muted" id="algorithmDescription">
                {% for algo in available_algorithms %}
                    {% if algo.value == current_algorithm %}{{ algo.description }}{% endif %}
                {% endfor %}
            </small>
        </div>
        <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-primary d-block" onclick="refreshRecommendations()">
                🔄 重新推薦
            </button>
        </div>
    </div>

    <!-- BGG 遊戲搜尋區域 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">🔍 搜尋遊戲並獲取推薦分數</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="gameSearchInput" placeholder="輸入遊戲名稱..." onkeypress="if(event.key=='Enter') searchGames()">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchGames()">
                            🔍 搜尋
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="exactSearch" value="">
                        <label class="form-check-label" for="exactSearch">
                            精確搜尋
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 搜尋結果區域 -->
            <div id="searchResults" class="d-none">
                <h6>搜尋結果：</h6>
                <div id="searchResultsList" class="list-group mb-3">
                    <!-- 動態填入搜尋結果 -->
                </div>
            </div>
            
            <!-- 推薦分數結果區域 -->
            <div id="recommendationResult" class="d-none">
                <div class="alert alert-success">
                    <h6 class="alert-heading">📊 推薦分數結果</h6>
                    <div id="recommendationContent">
                        <!-- 動態填入推薦結果 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    function changeAlgorithm() {
        const select = document.getElementById('algorithmSelect');
        const descriptions = {
            {% for algo in available_algorithms %}
            '{{ algo.value }}': '{{ algo.description }}',
            {% endfor %}
        };

        document.getElementById('algorithmDescription').textContent = descriptions[select.value];

        // 自動重新載入推薦
        const url = new URL(window.location);
        url.searchParams.set('algorithm', select.value);
        window.location.href = url.toString();
    }

    function refreshRecommendations() {
        window.location.reload();
    }

    // BGG 遊戲搜尋功能
    async function searchGames() {
        const query = document.getElementById('gameSearchInput').value.trim();
        const exact = document.getElementById('exactSearch').checked;
        
        if (!query) {
            alert('請輸入搜尋關鍵字');
            return;
        }
        
        try {
            const response = await fetch('/api/bgg/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query, exact: exact })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                alert('搜尋失敗: ' + data.message);
            }
        } catch (error) {
            console.error('搜尋錯誤:', error);
            alert('搜尋時發生錯誤');
        }
    }

    function displaySearchResults(results) {
        const searchResults = document.getElementById('searchResults');
        const searchResultsList = document.getElementById('searchResultsList');
        
        if (results.length === 0) {
            searchResultsList.innerHTML = '<div class="alert alert-warning">沒有找到相關遊戲</div>';
        } else {
            let html = '';
            results.forEach(game => {
                html += `
                    <div class="list-group-item list-group-item-action" onclick="getGameRecommendation('${game.id}', '${game.name}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${game.name}</h6>
                            <small class="text-muted">ID: ${game.id}</small>
                        </div>
                        <p class="mb-1">${game.year ? '發行年份: ' + game.year : ''}</p>
                        <small class="text-muted">點擊獲取推薦分數</small>
                    </div>
                `;
            });
            searchResultsList.innerHTML = html;
        }
        
        searchResults.classList.remove('d-none');
        document.getElementById('recommendationResult').classList.add('d-none');
    }

    async function getGameRecommendation(gameId, gameName) {
        try {
            const response = await fetch('/api/rg/recommend-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    game_name: gameName,
                    algorithm: document.getElementById('algorithmSelect').value
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayRecommendationResult(data.result);
            } else {
                alert('獲取推薦分數失敗: ' + data.message);
            }
        } catch (error) {
            console.error('推薦分數計算錯誤:', error);
            alert('計算推薦分數時發生錯誤');
        }
    }

    function displayRecommendationResult(result) {
        const recommendationResult = document.getElementById('recommendationResult');
        const recommendationContent = document.getElementById('recommendationContent');
        
        let html = `
            <div class="row">
                <div class="col-md-8">
                    <h5>${result.name} ${result.year ? '(' + result.year + ')' : ''}</h5>
                    <p><strong>推薦分數: ${result.score ? result.score.toFixed(2) : 'N/A'}</strong></p>
                    ${result.details ? '<p><small class="text-muted">詳情: ' + result.details + '</small></p>' : ''}
                </div>
                <div class="col-md-4 text-end">
                    <a href="https://boardgamegeek.com/boardgame/${result.game_id}" target="_blank" class="btn btn-outline-primary btn-sm">
                        在 BGG 查看
                    </a>
                </div>
            </div>
        `;
        
        recommendationContent.innerHTML = html;
        recommendationResult.classList.remove('d-none');
    }
    </script>

    {% if rg_results %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {% for g in rg_results %}
            <div class="col">
                <div class="card h-100">
                    {% if g.image %}
                    <img src="{{ g.image }}" class="card-img-top" alt="{{ g.name }}">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="https://boardgamegeek.com/boardgame/{{ g.game_id }}" target="_blank" rel="noopener noreferrer">{{ g.name }}</a>
                            {% if g.year %}<small class="text-muted">({{ g.year }})</small>{% endif %}
                        </h5>
                        <div class="mb-2">
                            {% if g.rating %}
                            <span class="badge bg-success">評分 {{ g.rating }}</span>
                            {% endif %}
                            {% if g.rank and g.rank > 0 %}
                            <span class="badge bg-info">#{{ g.rank }}</span>
                            {% endif %}
                            {% if g.weight %}
                            <span class="badge bg-warning">複雜度 {{ g.weight }}</span>
                            {% endif %}
                        </div>
                        {% if g.min_players and g.max_players %}
                        <p class="card-text"><small class="text-muted">{{ g.min_players }}-{{ g.max_players }} 人</small></p>
                        {% endif %}
                        {% if g.rec_score %}
                        <p class="card-text">
                            <strong>推薦分數：{{ '%.2f'|format(g.rec_score) }}</strong>
                            {% if g.source %}
                            <br><small class="text-muted">來源：{{ g.source }}</small>
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            {% if rg_error %}
                {% if "資料庫檔案不存在" in rg_error or "資料表" in rg_error or "沒有遊戲資料" in rg_error %}
                    <h5>📊 資料庫尚未初始化</h5>
                    <p>{{ rg_error }}</p>
                    <p>請先執行以下步驟來收集 BGG 資料：</p>
                    <ol>
                        <li>點擊下方「前往設定」</li>
                        <li>點擊「手動報表生成」開始收集熱門遊戲資料</li>
                        <li>等待資料收集完成後再返回此頁面訓練模型</li>
                    </ol>
                {% else %}
                    無法取得推薦：{{ rg_error }}
                {% endif %}
            {% elif not rg_error and not rg_results and bgg_username %}
                尚無推薦結果。
            {% else %}
                尚未設定外部服務，您可前往外部網站使用推薦或設定環境變數 <code>RG_API_URL</code>（與可選的 <code>RG_API_KEY</code>）。
            {% endif %}
        </div>
        <a class="btn btn-primary" href="{{ rg_site_url }}" target="_blank" rel="noopener noreferrer">前往 Recommend.Games</a>
        <a class="btn btn-outline-secondary" href="{{ rg_repo_url }}" target="_blank" rel="noopener noreferrer">查看原始碼</a>
    {% endif %}

    <div class="mt-3">
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">⚙️ 前往設定</a>
        <a href="{{ url_for('recommendations') }}" class="btn btn-outline-secondary">✨ 內建推薦</a>
    </div>
</div>
{% endblock %}


