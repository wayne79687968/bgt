{% extends "base.html" %}

{% block title %}RG æ¨è–¦ - BGG ç†±é–€éŠæˆ²å ±è¡¨{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>ğŸ§  é€²éšæ™ºèƒ½æ¨è–¦</h2>
    <p class="text-muted">BGG ä½¿ç”¨è€…ï¼š<strong>{{ bgg_username or 'æœªè¨­å®š' }}</strong></p>

    <!-- ç®—æ³•é¸æ“‡å™¨ -->
    <div class="row mb-4">
        <div class="col-md-8">
            <label for="algorithmSelect" class="form-label">ğŸ¯ é¸æ“‡æ¨è–¦ç®—æ³•ï¼š</label>
            <select class="form-select" id="algorithmSelect" onchange="changeAlgorithm()">
                {% for algo in available_algorithms %}
                <option value="{{ algo.value }}" {% if algo.value == current_algorithm %}selected{% endif %}>
                    {{ algo.name }}
                </option>
                {% endfor %}
            </select>
            <small class="form-text text-muted" id="algorithmDescription">
                {% for algo in available_algorithms %}
                    {% if algo.value == current_algorithm %}{{ algo.description }}{% endif %}
                {% endfor %}
            </small>
        </div>
        <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-primary d-block" onclick="refreshRecommendations()">
                ğŸ”„ é‡æ–°æ¨è–¦
            </button>
        </div>
    </div>

    <!-- BGG éŠæˆ²æœå°‹å€åŸŸ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ” æœå°‹éŠæˆ²ä¸¦ç²å–æ¨è–¦åˆ†æ•¸</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="gameSearchInput" placeholder="è¼¸å…¥éŠæˆ²åç¨±..." onkeypress="if(event.key=='Enter') searchGames()">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchGames()">
                            ğŸ” æœå°‹
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="exactSearch" value="">
                        <label class="form-check-label" for="exactSearch">
                            ç²¾ç¢ºæœå°‹
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- æœå°‹çµæœå€åŸŸ -->
            <div id="searchResults" class="d-none">
                <h6>æœå°‹çµæœï¼š</h6>
                <div id="searchResultsList" class="list-group mb-3">
                    <!-- å‹•æ…‹å¡«å…¥æœå°‹çµæœ -->
                </div>
            </div>
            
            <!-- æ¨è–¦åˆ†æ•¸çµæœå€åŸŸ -->
            <div id="recommendationResult" class="d-none">
                <div class="alert alert-success">
                    <h6 class="alert-heading">ğŸ“Š æ¨è–¦åˆ†æ•¸çµæœ</h6>
                    <div id="recommendationContent">
                        <!-- å‹•æ…‹å¡«å…¥æ¨è–¦çµæœ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    function changeAlgorithm() {
        const select = document.getElementById('algorithmSelect');
        const descriptions = {
            {% for algo in available_algorithms %}
            '{{ algo.value }}': '{{ algo.description }}',
            {% endfor %}
        };

        document.getElementById('algorithmDescription').textContent = descriptions[select.value];

        // è‡ªå‹•é‡æ–°è¼‰å…¥æ¨è–¦
        const url = new URL(window.location);
        url.searchParams.set('algorithm', select.value);
        window.location.href = url.toString();
    }

    function refreshRecommendations() {
        window.location.reload();
    }

    // BGG éŠæˆ²æœå°‹åŠŸèƒ½
    async function searchGames() {
        const query = document.getElementById('gameSearchInput').value.trim();
        const exact = document.getElementById('exactSearch').checked;
        
        if (!query) {
            alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
            return;
        }
        
        try {
            const response = await fetch('/api/bgg/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query, exact: exact })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                alert('æœå°‹å¤±æ•—: ' + data.message);
            }
        } catch (error) {
            console.error('æœå°‹éŒ¯èª¤:', error);
            alert('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    }

    function displaySearchResults(results) {
        const searchResults = document.getElementById('searchResults');
        const searchResultsList = document.getElementById('searchResultsList');
        
        if (results.length === 0) {
            searchResultsList.innerHTML = '<div class="alert alert-warning">æ²’æœ‰æ‰¾åˆ°ç›¸é—œéŠæˆ²</div>';
        } else {
            let html = '';
            results.forEach(game => {
                html += `
                    <div class="list-group-item list-group-item-action" onclick="getGameRecommendation('${game.id}', '${game.name}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${game.name}</h6>
                            <small class="text-muted">ID: ${game.id}</small>
                        </div>
                        <p class="mb-1">${game.year ? 'ç™¼è¡Œå¹´ä»½: ' + game.year : ''}</p>
                        <small class="text-muted">é»æ“Šç²å–æ¨è–¦åˆ†æ•¸</small>
                    </div>
                `;
            });
            searchResultsList.innerHTML = html;
        }
        
        searchResults.classList.remove('d-none');
        document.getElementById('recommendationResult').classList.add('d-none');
    }

    async function getGameRecommendation(gameId, gameName) {
        try {
            const response = await fetch('/api/rg/recommend-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    game_name: gameName,
                    algorithm: document.getElementById('algorithmSelect').value
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayRecommendationResult(data.result);
            } else {
                alert('ç²å–æ¨è–¦åˆ†æ•¸å¤±æ•—: ' + data.message);
            }
        } catch (error) {
            console.error('æ¨è–¦åˆ†æ•¸è¨ˆç®—éŒ¯èª¤:', error);
            alert('è¨ˆç®—æ¨è–¦åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    }

    function displayRecommendationResult(result) {
        const recommendationResult = document.getElementById('recommendationResult');
        const recommendationContent = document.getElementById('recommendationContent');
        
        let html = `
            <div class="row">
                <div class="col-md-8">
                    <h5>${result.name} ${result.year ? '(' + result.year + ')' : ''}</h5>
                    <p><strong>æ¨è–¦åˆ†æ•¸: ${result.score ? result.score.toFixed(2) : 'N/A'}</strong></p>
                    ${result.details ? '<p><small class="text-muted">è©³æƒ…: ' + result.details + '</small></p>' : ''}
                </div>
                <div class="col-md-4 text-end">
                    <a href="https://boardgamegeek.com/boardgame/${result.game_id}" target="_blank" class="btn btn-outline-primary btn-sm">
                        åœ¨ BGG æŸ¥çœ‹
                    </a>
                </div>
            </div>
        `;
        
        recommendationContent.innerHTML = html;
        recommendationResult.classList.remove('d-none');
    }
    </script>

    {% if rg_results %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {% for g in rg_results %}
            <div class="col">
                <div class="card h-100">
                    {% if g.image %}
                    <img src="{{ g.image }}" class="card-img-top" alt="{{ g.name }}">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="https://boardgamegeek.com/boardgame/{{ g.game_id }}" target="_blank" rel="noopener noreferrer">{{ g.name }}</a>
                            {% if g.year %}<small class="text-muted">({{ g.year }})</small>{% endif %}
                        </h5>
                        <div class="mb-2">
                            {% if g.rating %}
                            <span class="badge bg-success">è©•åˆ† {{ g.rating }}</span>
                            {% endif %}
                            {% if g.rank and g.rank > 0 %}
                            <span class="badge bg-info">#{{ g.rank }}</span>
                            {% endif %}
                            {% if g.weight %}
                            <span class="badge bg-warning">è¤‡é›œåº¦ {{ g.weight }}</span>
                            {% endif %}
                        </div>
                        {% if g.min_players and g.max_players %}
                        <p class="card-text"><small class="text-muted">{{ g.min_players }}-{{ g.max_players }} äºº</small></p>
                        {% endif %}
                        {% if g.rec_score %}
                        <p class="card-text">
                            <strong>æ¨è–¦åˆ†æ•¸ï¼š{{ '%.2f'|format(g.rec_score) }}</strong>
                            {% if g.source %}
                            <br><small class="text-muted">ä¾†æºï¼š{{ g.source }}</small>
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            {% if rg_error %}
                {% if "è³‡æ–™åº«æª”æ¡ˆä¸å­˜åœ¨" in rg_error or "è³‡æ–™è¡¨" in rg_error or "æ²’æœ‰éŠæˆ²è³‡æ–™" in rg_error %}
                    <h5>ğŸ“Š è³‡æ–™åº«å°šæœªåˆå§‹åŒ–</h5>
                    <p>{{ rg_error }}</p>
                    <p>è«‹å…ˆåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿä¾†æ”¶é›† BGG è³‡æ–™ï¼š</p>
                    <ol>
                        <li>é»æ“Šä¸‹æ–¹ã€Œå‰å¾€è¨­å®šã€</li>
                        <li>é»æ“Šã€Œæ‰‹å‹•å ±è¡¨ç”Ÿæˆã€é–‹å§‹æ”¶é›†ç†±é–€éŠæˆ²è³‡æ–™</li>
                        <li>ç­‰å¾…è³‡æ–™æ”¶é›†å®Œæˆå¾Œå†è¿”å›æ­¤é é¢è¨“ç·´æ¨¡å‹</li>
                    </ol>
                {% else %}
                    ç„¡æ³•å–å¾—æ¨è–¦ï¼š{{ rg_error }}
                {% endif %}
            {% elif not rg_error and not rg_results and bgg_username %}
                å°šç„¡æ¨è–¦çµæœã€‚
            {% else %}
                å°šæœªè¨­å®šå¤–éƒ¨æœå‹™ï¼Œæ‚¨å¯å‰å¾€å¤–éƒ¨ç¶²ç«™ä½¿ç”¨æ¨è–¦æˆ–è¨­å®šç’°å¢ƒè®Šæ•¸ <code>RG_API_URL</code>ï¼ˆèˆ‡å¯é¸çš„ <code>RG_API_KEY</code>ï¼‰ã€‚
            {% endif %}
        </div>
        <a class="btn btn-primary" href="{{ rg_site_url }}" target="_blank" rel="noopener noreferrer">å‰å¾€ Recommend.Games</a>
        <a class="btn btn-outline-secondary" href="{{ rg_repo_url }}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹åŸå§‹ç¢¼</a>
    {% endif %}

    <div class="mt-3">
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">âš™ï¸ å‰å¾€è¨­å®š</a>
        <a href="{{ url_for('recommendations') }}" class="btn btn-outline-secondary">âœ¨ å…§å»ºæ¨è–¦</a>
    </div>
</div>
{% endblock %}


