{% extends "base.html" %}

{% block title %}RG æ¨è–¦ - BGG ç†±é–€éŠæˆ²å ±è¡¨{% endblock %}

{% block head %}
<style>
/* Google Search é¢¨æ ¼çš„æ¨£å¼ */
.search-container {
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.search-logo {
    font-size: 3rem;
    margin-bottom: 2rem;
    font-weight: 300;
    color: #333;
}

.search-box {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin-bottom: 2rem;
}

.search-input {
    width: 100%;
    height: 50px;
    border: 2px solid #ddd;
    border-radius: 25px;
    padding: 0 50px 0 20px;
    font-size: 16px;
    outline: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
}

.search-input:focus {
    border-color: #4285f4;
    box-shadow: 0 4px 20px rgba(66,133,244,0.2), 0 0 0 3px rgba(66,133,244,0.1);
    transform: translateY(-1px);
}

.search-input::placeholder {
    color: #999;
    transition: color 0.3s ease;
}

.search-input:focus::placeholder {
    color: #bbb;
}

.search-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #4285f4, #34a853);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(66,133,244,0.3);
}

.search-btn:hover {
    background: linear-gradient(135deg, #3367d6, #2d7d32);
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 4px 15px rgba(66,133,244,0.4);
}

.search-btn:active {
    transform: translateY(-50%) scale(0.95);
}

.search-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 2rem;
}

.search-options button {
    padding: 12px 24px;
    border: 1px solid #ddd;
    border-radius: 25px;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    color: #333;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.search-options button:hover {
    border-color: #4285f4;
    color: #4285f4;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66,133,244,0.15);
}

.search-options button.active {
    background: linear-gradient(135deg, #4285f4, #34a853);
    color: white;
    border-color: #4285f4;
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(66,133,244,0.3);
}

/* æµ®çª—æ¨£å¼ */
.search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: none;
}

.search-popup {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 90vw;
    width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}

.search-result-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
    margin-bottom: 10px;
    animation: slideInUp 0.4s ease;
    animation-fill-mode: both;
}

.search-result-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.recommendation-score {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.score-high { background: linear-gradient(135deg, #28a745, #20c997); }
.score-medium { background: linear-gradient(135deg, #ffc107, #fd7e14); }
.score-low { background: linear-gradient(135deg, #dc3545, #e83e8c); }

.grid-view {
    display: none;
}

.grid-view.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.close-btn:hover {
    color: #333;
}

.user-info {
    position: absolute;
    top: 20px;
    right: 20px;
    color: #666;
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ä½¿ç”¨è€…è³‡è¨Š -->
    <div class="user-info">
        BGG ä½¿ç”¨è€…ï¼š<strong>{{ bgg_username or 'æœªè¨­å®š' }}</strong>
    </div>
    
    <!-- Google Search é¢¨æ ¼çš„ä¸»ä»‹é¢ -->
    <div class="search-container" id="mainSearch">
        <div class="search-logo">ğŸ§  RG æ™ºèƒ½æ¨è–¦</div>
        
        <div class="search-box">
            <input type="text" class="search-input" id="gameSearchInput" placeholder="æœå°‹æ¡ŒéŠåç¨±ï¼Œç²å–å€‹äººåŒ–æ¨è–¦åˆ†æ•¸..." onkeypress="if(event.key=='Enter') searchGames()">
            <button class="search-btn" onclick="searchGames()">ğŸ”</button>
        </div>
        
        <div class="search-options">
            <button id="exactSearchBtn" onclick="toggleExactSearch()">ç²¾ç¢ºæœå°‹</button>
            <button id="directRecommendBtn" onclick="showDirectRecommendations()" class="active">ğŸ“‹ ç›´æ¥æ¨è–¦</button>
            <button onclick="showAlgorithmSettings()">âš™ï¸ ç®—æ³•è¨­å®š</button>
        </div>
    </div>
    
    <!-- æ ¼ç‹€æ¨è–¦åˆ—è¡¨å€åŸŸ (éš±è—çš„) -->
    <div class="grid-view" id="gridView">
        <div class="container-fluid mt-3">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>ğŸ“‹ ç›´æ¥æ¨è–¦åˆ—è¡¨</h3>
                <button class="btn btn-outline-secondary" onclick="backToSearch()">â† è¿”å›æœå°‹</button>
            </div>
            
            <!-- ç®—æ³•é¸æ“‡å™¨ -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <select class="form-select" id="algorithmSelect" onchange="changeAlgorithm()">
                        {% for algo in available_algorithms %}
                        <option value="{{ algo.value }}" {% if algo.value == current_algorithm %}selected{% endif %}>
                            {{ algo.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted" id="algorithmDescription">
                        {% for algo in available_algorithms %}
                            {% if algo.value == current_algorithm %}{{ algo.description }}{% endif %}
                        {% endfor %}
                    </small>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-primary" onclick="refreshRecommendations()">
                        ğŸ”„ é‡æ–°æ¨è–¦
                    </button>
                </div>
            </div>

    <!-- æœå°‹çµæœæµ®çª— -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-popup">
            <button class="close-btn" onclick="closeSearchResults()">Ã—</button>
            <h4>ğŸ² éŠæˆ²æœå°‹çµæœ</h4>
            <div id="searchResultsList">
                <!-- æœå°‹çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <script>
    let exactSearch = false;

    function changeAlgorithm() {
        const select = document.getElementById('algorithmSelect');
        const descriptions = {
            {% for algo in available_algorithms %}
            '{{ algo.value }}': '{{ algo.description }}',
            {% endfor %}
        };

        document.getElementById('algorithmDescription').textContent = descriptions[select.value];

        // è‡ªå‹•é‡æ–°è¼‰å…¥æ¨è–¦
        const url = new URL(window.location);
        url.searchParams.set('algorithm', select.value);
        window.location.href = url.toString();
    }

    function refreshRecommendations() {
        window.location.reload();
    }

    function toggleExactSearch() {
        exactSearch = !exactSearch;
        const btn = document.getElementById('exactSearchBtn');
        if (exactSearch) {
            btn.classList.add('active');
            btn.textContent = 'âœ“ ç²¾ç¢ºæœå°‹';
        } else {
            btn.classList.remove('active');
            btn.textContent = 'ç²¾ç¢ºæœå°‹';
        }
    }

    function showDirectRecommendations() {
        document.getElementById('mainSearch').style.display = 'none';
        document.getElementById('gridView').classList.add('active');
    }

    function backToSearch() {
        document.getElementById('mainSearch').style.display = 'flex';
        document.getElementById('gridView').classList.remove('active');
        document.getElementById('gridView').style.display = 'none';
    }

    function showAlgorithmSettings() {
        alert('ç®—æ³•è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...');
    }

    function closeSearchResults() {
        const overlay = document.getElementById('searchOverlay');
        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.style.animation = '';
        }, 300);
    }

    // BGG éŠæˆ²æœå°‹åŠŸèƒ½
    async function searchGames() {
        const query = document.getElementById('gameSearchInput').value.trim();
        
        if (!query) {
            showNotification('è«‹è¼¸å…¥æœå°‹é—œéµå­—', 'warning');
            return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        const searchBtn = document.querySelector('.search-btn');
        const originalContent = searchBtn.innerHTML;
        searchBtn.innerHTML = 'â³';
        
        try {
            const response = await fetch('/api/bgg/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query, exact: exactSearch })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                showNotification('æœå°‹å¤±æ•—: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('æœå°‹éŒ¯èª¤:', error);
            showNotification('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        } finally {
            searchBtn.innerHTML = originalContent;
        }
    }

    function displaySearchResults(results) {
        const searchResultsList = document.getElementById('searchResultsList');
        
        if (results.length === 0) {
            searchResultsList.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">æ²’æœ‰æ‰¾åˆ°ç›¸é—œéŠæˆ²</p>
                    <small>è©¦è©¦èª¿æ•´æœå°‹é—œéµå­—æˆ–å–æ¶ˆç²¾ç¢ºæœå°‹</small>
                </div>
            `;
        } else {
            let html = '';
            results.forEach((game, index) => {
                html += `
                    <div class="search-result-item" onclick="getGameRecommendation('${game.id}', '${game.name}')" style="animation-delay: ${index * 0.05}s">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${game.name}</h6>
                                <small class="text-muted">${game.year ? 'ç™¼è¡Œå¹´ä»½: ' + game.year : 'BGG ID: ' + game.id}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-light text-dark">${game.id}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-primary">é»æ“Šç²å–æ¨è–¦åˆ†æ•¸ â†’</small>
                        </div>
                    </div>
                `;
            });
            searchResultsList.innerHTML = html;
        }
        
        // é¡¯ç¤ºæœå°‹çµæœæµ®çª—
        const overlay = document.getElementById('searchOverlay');
        overlay.style.display = 'block';
        overlay.style.animation = 'fadeIn 0.3s ease';
    }

    async function getGameRecommendation(gameId, gameName) {
        try {
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const loadingHtml = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¨ˆç®—ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨è¨ˆç®—æ¨è–¦åˆ†æ•¸...</p>
                </div>
            `;
            document.getElementById('searchResultsList').innerHTML = loadingHtml;

            const algorithmSelect = document.getElementById('algorithmSelect');
            const algorithm = algorithmSelect ? algorithmSelect.value : 'hybrid';
            
            const response = await fetch('/api/rg/recommend-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    game_name: gameName,
                    algorithm: algorithm
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayRecommendationResult(data.result);
            } else {
                showNotification('ç²å–æ¨è–¦åˆ†æ•¸å¤±æ•—: ' + data.message, 'error');
                // é‡æ–°é¡¯ç¤ºæœå°‹çµæœ
                searchGames();
            }
        } catch (error) {
            console.error('æ¨è–¦åˆ†æ•¸è¨ˆç®—éŒ¯èª¤:', error);
            showNotification('è¨ˆç®—æ¨è–¦åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
    }

    function displayRecommendationResult(result) {
        let scoreClass = 'score-medium';
        if (result.score >= 7) scoreClass = 'score-high';
        else if (result.score < 5) scoreClass = 'score-low';

        const html = `
            <div class="text-center py-4" style="animation: slideInUp 0.4s ease">
                <div class="mb-3">
                    <h5>${result.name}</h5>
                    ${result.year ? `<small class="text-muted">(${result.year})</small>` : ''}
                </div>
                
                <div class="mb-4">
                    <span class="recommendation-score ${scoreClass}">
                        ${result.score ? result.score.toFixed(2) : 'N/A'} åˆ†
                    </span>
                </div>
                
                ${result.details ? `
                    <div class="mb-3">
                        <small class="text-muted">${result.details}</small>
                    </div>
                ` : ''}
                
                <div class="d-flex gap-2 justify-content-center">
                    <a href="https://boardgamegeek.com/boardgame/${result.game_id}" target="_blank" class="btn btn-outline-primary btn-sm">
                        åœ¨ BGG æŸ¥çœ‹
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="searchGames()">
                        â† è¿”å›æœå°‹
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('searchResultsList').innerHTML = html;
    }

    function showNotification(message, type = 'info') {
        // å‰µå»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} notification`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // æ·»åŠ  CSS å‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    </script>

    {% if rg_results %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {% for g in rg_results %}
            <div class="col">
                <div class="card h-100">
                    {% if g.image %}
                    <img src="{{ g.image }}" class="card-img-top" alt="{{ g.name }}">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="https://boardgamegeek.com/boardgame/{{ g.game_id }}" target="_blank" rel="noopener noreferrer">{{ g.name }}</a>
                            {% if g.year %}<small class="text-muted">({{ g.year }})</small>{% endif %}
                        </h5>
                        <div class="mb-2">
                            {% if g.rating %}
                            <span class="badge bg-success">è©•åˆ† {{ g.rating }}</span>
                            {% endif %}
                            {% if g.rank and g.rank > 0 %}
                            <span class="badge bg-info">#{{ g.rank }}</span>
                            {% endif %}
                            {% if g.weight %}
                            <span class="badge bg-warning">è¤‡é›œåº¦ {{ g.weight }}</span>
                            {% endif %}
                        </div>
                        {% if g.min_players and g.max_players %}
                        <p class="card-text"><small class="text-muted">{{ g.min_players }}-{{ g.max_players }} äºº</small></p>
                        {% endif %}
                        {% if g.rec_score %}
                        <p class="card-text">
                            <strong>æ¨è–¦åˆ†æ•¸ï¼š{{ '%.2f'|format(g.rec_score) }}</strong>
                            {% if g.source %}
                            <br><small class="text-muted">ä¾†æºï¼š{{ g.source }}</small>
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            {% if rg_error %}
                {% if "è³‡æ–™åº«æª”æ¡ˆä¸å­˜åœ¨" in rg_error or "è³‡æ–™è¡¨" in rg_error or "æ²’æœ‰éŠæˆ²è³‡æ–™" in rg_error %}
                    <h5>ğŸ“Š è³‡æ–™åº«å°šæœªåˆå§‹åŒ–</h5>
                    <p>{{ rg_error }}</p>
                    <p>è«‹å…ˆåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿä¾†æ”¶é›† BGG è³‡æ–™ï¼š</p>
                    <ol>
                        <li>é»æ“Šä¸‹æ–¹ã€Œå‰å¾€è¨­å®šã€</li>
                        <li>é»æ“Šã€Œæ‰‹å‹•å ±è¡¨ç”Ÿæˆã€é–‹å§‹æ”¶é›†ç†±é–€éŠæˆ²è³‡æ–™</li>
                        <li>ç­‰å¾…è³‡æ–™æ”¶é›†å®Œæˆå¾Œå†è¿”å›æ­¤é é¢è¨“ç·´æ¨¡å‹</li>
                    </ol>
                {% else %}
                    ç„¡æ³•å–å¾—æ¨è–¦ï¼š{{ rg_error }}
                {% endif %}
            {% elif not rg_error and not rg_results and bgg_username %}
                å°šç„¡æ¨è–¦çµæœã€‚
            {% else %}
                å°šæœªè¨­å®šå¤–éƒ¨æœå‹™ï¼Œæ‚¨å¯å‰å¾€å¤–éƒ¨ç¶²ç«™ä½¿ç”¨æ¨è–¦æˆ–è¨­å®šç’°å¢ƒè®Šæ•¸ <code>RG_API_URL</code>ï¼ˆèˆ‡å¯é¸çš„ <code>RG_API_KEY</code>ï¼‰ã€‚
            {% endif %}
        </div>
        <a class="btn btn-primary" href="{{ rg_site_url }}" target="_blank" rel="noopener noreferrer">å‰å¾€ Recommend.Games</a>
        <a class="btn btn-outline-secondary" href="{{ rg_repo_url }}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹åŸå§‹ç¢¼</a>
    {% endif %}

    <div class="mt-3">
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">âš™ï¸ å‰å¾€è¨­å®š</a>
        <a href="{{ url_for('recommendations') }}" class="btn btn-outline-secondary">âœ¨ å…§å»ºæ¨è–¦</a>
    </div>
</div>
{% endblock %}


