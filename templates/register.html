{% extends "base.html" %}

{% block title %}è¨»å†Š - BGG ç¶œåˆåˆ†æå¹³å°{% endblock %}

{% block content %}
<style>
/* å…±äº«æ¨£å¼ - èˆ‡ç™»å…¥é é¢ä¸€è‡´ */
.auth-background {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    position: relative;
    overflow: hidden;
}

.auth-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
    opacity: 0.5;
}

.auth-card {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    transform: translateY(20px);
    animation: slideUp 0.6s ease-out forwards;
}

@keyframes slideUp {
    to { transform: translateY(0); }
}

.auth-title {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
    font-size: 2.5rem;
    animation: fadeInDown 0.8s ease-out 0.2s both;
}

@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-control {
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    background: rgba(255, 255, 255, 1);
    transform: translateY(-2px);
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.btn-auth {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1.1rem;
    color: white;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-auth:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
}

.btn-auth:active { transform: translateY(0); }
.btn-auth:disabled { opacity: 0.7; transform: none; cursor: not-allowed; }

.btn-secondary-auth {
    background: linear-gradient(135deg, #6c757d, #495057);
    border: none;
    border-radius: 15px;
    padding: 0.8rem 1.5rem;
    font-weight: 600;
    color: white;
    transition: all 0.3s ease;
}

.btn-secondary-auth:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
}

/* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
    position: relative;
}

.step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 1rem;
    font-weight: bold;
    color: #6c757d;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
}

.step.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    transform: scale(1.2);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.step.completed {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    transform: scale(1.1);
}

.step-connector {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translateY(-50%);
    width: 100%;
    height: 2px;
    background: rgba(255, 255, 255, 0.3);
    z-index: 1;
}

.step-connector.active {
    background: linear-gradient(90deg, #28a745, #667eea);
}

/* è¡¨å–®å‹•ç•« */
.form-step {
    animation: fadeInUp 0.6s ease-out both;
    min-height: 300px;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-step.slide-out {
    animation: slideOutLeft 0.4s ease-out both;
}

.form-step.slide-in {
    animation: slideInRight 0.4s ease-out both;
}

@keyframes slideOutLeft {
    to { opacity: 0; transform: translateX(-50px); }
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(50px); }
    to { opacity: 1; transform: translateX(0); }
}

/* Alert æ¨£å¼ */
.alert {
    border-radius: 15px;
    border: none;
    animation: bounceIn 0.5s ease-out;
}

@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}

/* è¼¸å…¥é©—è­‰æ¨£å¼ */
.form-control.is-valid {
    border-color: #28a745;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.98-.97 2.47 2.47c.137.137.36.137.498 0 .137-.138.137-.36 0-.498L3.79 5.28c-.138-.137-.36-.137-.498 0L2.3 6.27z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 576px) {
    .auth-card { margin: 1rem; border-radius: 15px; }
    .auth-title { font-size: 2rem; }
    .step { margin: 0 0.5rem; }
}
</style>

<div class="auth-background">
    <div class="container-fluid">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-6 col-lg-5">
                <div class="auth-card p-5">
                    <div class="text-center mb-4">
                        <h1 class="auth-title mb-3">ğŸ² BGG åˆ†æå¹³å°</h1>
                        <p class="text-muted lead">å»ºç«‹æ‚¨çš„å°ˆå±¬å¸³è™Ÿ</p>
                    </div>
                    
                    <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
                    <div class="step-indicator">
                        <div class="step-connector"></div>
                        <div class="step active" id="step-indicator-1">1</div>
                        <div class="step" id="step-indicator-2">2</div>
                        <div class="step" id="step-indicator-3">3</div>
                    </div>
                    
                    <!-- æ­¥é©Ÿä¸€ï¼šè¼¸å…¥ Email -->
                    <div id="step1" class="form-step">
                        <div class="text-center mb-4">
                            <h4 class="mb-3">ğŸ“§ è¼¸å…¥æ‚¨çš„ Email</h4>
                            <p class="text-muted">æˆ‘å€‘å°‡ç™¼é€é©—è­‰ç¢¼åˆ°æ‚¨çš„ä¿¡ç®±</p>
                        </div>
                        <form id="emailForm">
                            <div class="mb-4">
                                <label for="email" class="form-label">Email åœ°å€</label>
                                <input type="email" class="form-control" id="email" name="email" required 
                                       placeholder="è«‹è¼¸å…¥æ‚¨çš„ Email åœ°å€">
                                <div class="form-text">è«‹ç¢ºä¿èƒ½å¤ æ¥æ”¶éƒµä»¶çš„æœ‰æ•ˆä¿¡ç®±</div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-auth btn-lg" id="sendVerifyBtn">
                                    <span class="spinner-border spinner-border-sm d-none me-2" id="emailSpinner"></span>
                                    <span id="sendBtnText">ç™¼é€é©—è­‰ç¢¼</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- æ­¥é©ŸäºŒï¼šé©—è­‰ Email -->
                    <div id="step2" class="form-step d-none">
                        <div class="text-center mb-4">
                            <h4 class="mb-3">ğŸ” è¼¸å…¥é©—è­‰ç¢¼</h4>
                            <p class="text-muted">é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±</p>
                        </div>
                        <form id="verifyForm">
                            <div class="alert alert-info">
                                <i class="fas fa-envelope me-2"></i>
                                é©—è­‰ç¢¼å·²ç™¼é€åˆ° <strong id="emailDisplay"></strong>
                            </div>
                            <div class="mb-4">
                                <label for="verifyCode" class="form-label">é©—è­‰ç¢¼</label>
                                <input type="text" class="form-control text-center" id="verifyCode" name="code" 
                                       maxlength="6" placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼" required
                                       style="font-size: 1.2rem; letter-spacing: 0.3rem;">
                                <div class="form-text">é©—è­‰ç¢¼å°‡åœ¨ 10 åˆ†é˜å¾Œå¤±æ•ˆ</div>
                            </div>
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-auth btn-lg" id="verifyBtn">
                                    <span class="spinner-border spinner-border-sm d-none me-2" id="verifySpinner"></span>
                                    <span id="verifyBtnText">é©—è­‰ä¸¦ç¹¼çºŒ</span>
                                </button>
                            </div>
                            <div class="text-center">
                                <button type="button" class="btn btn-secondary-auth btn-sm" id="resendBtn">
                                    <i class="fas fa-redo me-1"></i>
                                    <span id="resendBtnText">é‡æ–°ç™¼é€é©—è­‰ç¢¼</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- æ­¥é©Ÿä¸‰ï¼šè¨­å®šå¯†ç¢¼ -->
                    <div id="step3" class="form-step d-none">
                        <div class="text-center mb-4">
                            <h4 class="mb-3">ğŸ”’ è¨­å®šç™»å…¥å¯†ç¢¼</h4>
                            <p class="text-muted">å‰µå»ºä¸€å€‹å®‰å…¨çš„å¯†ç¢¼ä¾†ä¿è­·æ‚¨çš„å¸³è™Ÿ</p>
                        </div>
                        <form id="passwordForm">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Email é©—è­‰æˆåŠŸï¼æœ€å¾Œä¸€æ­¥è¨­å®šå¯†ç¢¼å³å¯å®Œæˆè¨»å†Š
                            </div>
                            <div class="mb-4">
                                <label for="password" class="form-label">å¯†ç¢¼</label>
                                <input type="password" class="form-control" id="password" name="password" 
                                       minlength="6" required placeholder="è«‹è¼¸å…¥è‡³å°‘ 6 å€‹å­—ç¬¦çš„å¯†ç¢¼">
                                <div class="form-text">å»ºè­°ä½¿ç”¨åŒ…å«æ•¸å­—ã€å­—æ¯çš„çµ„åˆ</div>
                            </div>
                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label">ç¢ºèªå¯†ç¢¼</label>
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                       required placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼">
                                <div id="passwordMatch" class="form-text"></div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-auth btn-lg" id="registerBtn">
                                    <span class="spinner-border spinner-border-sm d-none me-2" id="registerSpinner"></span>
                                    <span id="registerBtnText">ğŸ‰ å®Œæˆè¨»å†Š</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- é è…³é€£çµ -->
                    <div class="text-center mt-4">
                        <p class="text-muted">
                            å·²æœ‰å¸³è™Ÿï¼Ÿ<a href="/login_email" class="ms-1" style="color: #667eea; font-weight: 500;">ç«‹å³ç™»å…¥</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">ç³»çµ±é€šçŸ¥</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentEmail = '';
    let currentStep = 1;
    
    // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
    function updateStepIndicator(step, completed = false) {
        // é‡ç½®æ‰€æœ‰æ­¥é©Ÿç‹€æ…‹
        for (let i = 1; i <= 3; i++) {
            const stepElement = document.getElementById(`step-indicator-${i}`);
            stepElement.classList.remove('active', 'completed');
            
            if (i < step || (i === step && completed)) {
                stepElement.classList.add('completed');
                stepElement.innerHTML = '<i class="fas fa-check"></i>';
            } else if (i === step) {
                stepElement.classList.add('active');
                stepElement.textContent = i;
            } else {
                stepElement.textContent = i;
            }
        }
        
        // æ›´æ–°é€£æ¥ç·š
        const connector = document.querySelector('.step-connector');
        if (step > 1 || completed) {
            connector.classList.add('active');
        }
        
        currentStep = step;
    }
    
    // åˆ‡æ›æ­¥é©Ÿå‹•ç•«
    function switchToStep(fromStep, toStep) {
        const fromElement = document.getElementById(`step${fromStep}`);
        const toElement = document.getElementById(`step${toStep}`);
        
        // æ»‘å‡ºå‹•ç•«
        fromElement.classList.add('slide-out');
        
        setTimeout(() => {
            fromElement.classList.add('d-none');
            fromElement.classList.remove('slide-out');
            
            // æ»‘å…¥å‹•ç•«
            toElement.classList.remove('d-none');
            toElement.classList.add('slide-in');
            
            setTimeout(() => {
                toElement.classList.remove('slide-in');
            }, 400);
            
            updateStepIndicator(toStep);
        }, 200);
    }
    
    // é¡¯ç¤ºé€šçŸ¥
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        
        toastMessage.textContent = message;
        
        // ç§»é™¤èˆŠçš„é¡åˆ¥
        toast.classList.remove('bg-danger', 'bg-success', 'bg-info', 'text-white');
        
        // æ·»åŠ æ–°çš„é¡åˆ¥
        if (type === 'error') {
            toast.classList.add('bg-danger', 'text-white');
        } else if (type === 'success') {
            toast.classList.add('bg-success', 'text-white');
        } else {
            toast.classList.add('bg-info', 'text-white');
        }
        
        const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
        bsToast.show();
    }
    
    // è¨­ç½®æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
    function setButtonLoading(button, spinner, textElement, loading, loadingText, normalText) {
        if (loading) {
            button.disabled = true;
            spinner.classList.remove('d-none');
            textElement.textContent = loadingText;
            button.style.transform = 'scale(0.98)';
        } else {
            button.disabled = false;
            spinner.classList.add('d-none');
            textElement.textContent = normalText;
            button.style.transform = 'scale(1)';
        }
    }
    
    // è¼¸å…¥æ¡†å‹•æ…‹æ•ˆæœ
    function setupInputEffects() {
        const inputs = document.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
                this.style.transform = 'translateY(-2px)';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
                this.style.transform = 'translateY(0)';
            });
            
            // å³æ™‚é©—è­‰è¦–è¦ºåé¥‹
            input.addEventListener('input', function() {
                if (this.type === 'email') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (emailRegex.test(this.value)) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else if (this.value.length > 0) {
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                    }
                } else if (this.minLength && this.value.length >= this.minLength) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else if (this.value.length > 0 && this.minLength) {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
    }
    
    // åˆå§‹åŒ–è¼¸å…¥æ¡†æ•ˆæœ
    setupInputEffects();
    
    // æ­¥é©Ÿä¸€ï¼šç™¼é€é©—è­‰ç¢¼
    document.getElementById('emailForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const emailInput = document.getElementById('email');
        
        // é©—è­‰ Email æ ¼å¼
        if (!emailInput.validity.valid) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€', 'error');
            emailInput.focus();
            return;
        }
        
        const sendVerifyBtn = document.getElementById('sendVerifyBtn');
        const emailSpinner = document.getElementById('emailSpinner');
        const sendBtnText = document.getElementById('sendBtnText');
        
        setButtonLoading(sendVerifyBtn, emailSpinner, sendBtnText, true, 'ç™¼é€ä¸­...', 'ç™¼é€é©—è­‰ç¢¼');
        
        // æ·»åŠ æäº¤å‹•ç•«
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 100);
        
        try {
            const response = await fetch('/auth/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    type: 'register'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentEmail = email;
                document.getElementById('emailDisplay').textContent = email;
                
                // æˆåŠŸå‹•ç•«
                sendVerifyBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                sendBtnText.textContent = 'ç™¼é€æˆåŠŸï¼';
                
                setTimeout(() => {
                    switchToStep(1, 2);
                    showToast('é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±', 'success');
                    
                    // è‡ªå‹•èšç„¦åˆ°é©—è­‰ç¢¼è¼¸å…¥æ¡†
                    setTimeout(() => {
                        document.getElementById('verifyCode').focus();
                    }, 500);
                }, 800);
            } else {
                // éŒ¯èª¤å‹•ç•«
                sendVerifyBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                sendBtnText.textContent = 'ç™¼é€å¤±æ•—';
                
                showToast(result.message || 'ç™¼é€å¤±æ•—', 'error');
                
                setTimeout(() => {
                    sendVerifyBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    sendBtnText.textContent = 'é‡è©¦ç™¼é€';
                }, 2000);
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦', 'error');
            
            // ç¶²çµ¡éŒ¯èª¤å‹•ç•«
            sendVerifyBtn.style.background = 'linear-gradient(135deg, #ffc107, #fd7e14)';
            sendBtnText.textContent = 'ç¶²çµ¡éŒ¯èª¤';
            
            setTimeout(() => {
                sendVerifyBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                sendBtnText.textContent = 'é‡è©¦ç™¼é€';
            }, 2000);
        } finally {
            setTimeout(() => {
                setButtonLoading(sendVerifyBtn, emailSpinner, sendBtnText, false, 'ç™¼é€ä¸­...', 'ç™¼é€é©—è­‰ç¢¼');
            }, 1000);
        }
    });
    
    // é©—è­‰ç¢¼è¼¸å…¥æ ¼å¼åŒ–
    document.getElementById('verifyCode').addEventListener('input', function() {
        // åªå…è¨±æ•¸å­—
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // è‡ªå‹•æäº¤ï¼ˆ6ä½æ•¸æ™‚ï¼‰
        if (this.value.length === 6) {
            setTimeout(() => {
                document.getElementById('verifyForm').dispatchEvent(new Event('submit'));
            }, 300);
        }
    });
    
    // æ­¥é©ŸäºŒï¼šé©—è­‰ç¢¼é©—è­‰
    document.getElementById('verifyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const code = document.getElementById('verifyCode').value;
        
        if (code.length !== 6) {
            showToast('è«‹è¼¸å…¥å®Œæ•´çš„ 6 ä½æ•¸é©—è­‰ç¢¼', 'error');
            return;
        }
        
        const verifyBtn = document.getElementById('verifyBtn');
        const verifySpinner = document.getElementById('verifySpinner');
        const verifyBtnText = document.getElementById('verifyBtnText');
        
        setButtonLoading(verifyBtn, verifySpinner, verifyBtnText, true, 'é©—è­‰ä¸­...', 'é©—è­‰ä¸¦ç¹¼çºŒ');
        
        // æ·»åŠ æäº¤å‹•ç•«
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 100);
        
        try {
            const response = await fetch('/auth/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: currentEmail,
                    code: code,
                    type: 'register'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                updateStepIndicator(2, true);
                
                // æˆåŠŸå‹•ç•«
                verifyBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                verifyBtnText.textContent = 'é©—è­‰æˆåŠŸï¼';
                
                setTimeout(() => {
                    switchToStep(2, 3);
                    showToast('é©—è­‰æˆåŠŸï¼è«‹è¨­å®šç™»å…¥å¯†ç¢¼', 'success');
                    
                    // è‡ªå‹•èšç„¦åˆ°å¯†ç¢¼è¼¸å…¥æ¡†
                    setTimeout(() => {
                        document.getElementById('password').focus();
                    }, 500);
                }, 800);
            } else {
                // éŒ¯èª¤å‹•ç•«
                verifyBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                verifyBtnText.textContent = 'é©—è­‰å¤±æ•—';
                
                showToast(result.message || 'é©—è­‰å¤±æ•—', 'error');
                
                // æ–æ“ºå‹•ç•«
                this.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    this.style.animation = '';
                    verifyBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    verifyBtnText.textContent = 'é‡æ–°é©—è­‰';
                }, 500);
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦èšç„¦
                document.getElementById('verifyCode').value = '';
                document.getElementById('verifyCode').focus();
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            
            // ç¶²çµ¡éŒ¯èª¤å‹•ç•«
            verifyBtn.style.background = 'linear-gradient(135deg, #ffc107, #fd7e14)';
            verifyBtnText.textContent = 'ç¶²çµ¡éŒ¯èª¤';
            
            setTimeout(() => {
                verifyBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                verifyBtnText.textContent = 'é‡æ–°é©—è­‰';
            }, 2000);
        } finally {
            setTimeout(() => {
                setButtonLoading(verifyBtn, verifySpinner, verifyBtnText, false, 'é©—è­‰ä¸­...', 'é©—è­‰ä¸¦ç¹¼çºŒ');
            }, 1000);
        }
    });
    
    // é‡æ–°ç™¼é€é©—è­‰ç¢¼
    document.getElementById('resendBtn').addEventListener('click', async function() {
        const resendBtn = this;
        const resendBtnText = document.getElementById('resendBtnText');
        
        resendBtn.disabled = true;
        resendBtn.style.transform = 'scale(0.95)';
        
        try {
            const response = await fetch('/auth/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: currentEmail,
                    type: 'register'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('é©—è­‰ç¢¼å·²é‡æ–°ç™¼é€', 'success');
                
                // å€’æ•¸è¨ˆæ™‚å‹•ç•«
                let countdown = 60;
                const originalHTML = resendBtn.innerHTML;
                
                const updateCountdown = () => {
                    resendBtn.innerHTML = `<i class="fas fa-clock me-1"></i> é‡æ–°ç™¼é€ (${countdown})`;
                    resendBtn.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
                };
                
                updateCountdown();
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        updateCountdown();
                    } else {
                        clearInterval(timer);
                        resendBtn.innerHTML = originalHTML;
                        resendBtn.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
                        resendBtn.style.transform = 'scale(1)';
                        resendBtn.disabled = false;
                    }
                }, 1000);
            } else {
                showToast(result.message || 'ç™¼é€å¤±æ•—', 'error');
                resendBtn.disabled = false;
                resendBtn.style.transform = 'scale(1)';
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            resendBtn.disabled = false;
            resendBtn.style.transform = 'scale(1)';
        }
    });
    
    // å¯†ç¢¼å¼·åº¦æª¢æŸ¥
    function checkPasswordStrength(password) {
        const strengthIndicator = document.getElementById('passwordMatch');
        if (!password) {
            strengthIndicator.textContent = '';
            return;
        }
        
        let strength = 0;
        let feedback = [];
        
        if (password.length >= 8) strength++;
        else feedback.push('è‡³å°‘8å€‹å­—ç¬¦');
        
        if (/[a-z]/.test(password)) strength++;
        else feedback.push('åŒ…å«å°å¯«å­—æ¯');
        
        if (/[A-Z]/.test(password)) strength++;
        else feedback.push('åŒ…å«å¤§å¯«å­—æ¯');
        
        if (/[0-9]/.test(password)) strength++;
        else feedback.push('åŒ…å«æ•¸å­—');
        
        if (/[^a-zA-Z0-9]/.test(password)) strength++;
        else feedback.push('åŒ…å«ç‰¹æ®Šå­—ç¬¦');
        
        const colors = ['#dc3545', '#ffc107', '#fd7e14', '#28a745', '#20c997'];
        const labels = ['å¾ˆå¼±', 'å¼±', 'æ™®é€š', 'å¼·', 'å¾ˆå¼·'];
        
        strengthIndicator.style.color = colors[strength - 1] || '#6c757d';
        strengthIndicator.textContent = password.length >= 6 ? 
            `å¯†ç¢¼å¼·åº¦ï¼š${labels[strength - 1] || 'å¾ˆå¼±'}` : 
            'å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—ç¬¦';
    }
    
    // å¯†ç¢¼è¼¸å…¥ç›£è½
    document.getElementById('password').addEventListener('input', function() {
        checkPasswordStrength(this.value);
        
        // æª¢æŸ¥ç¢ºèªå¯†ç¢¼
        const confirmPassword = document.getElementById('confirmPassword');
        if (confirmPassword.value) {
            confirmPassword.dispatchEvent(new Event('input'));
        }
    });
    
    // å¯†ç¢¼ç¢ºèªå³æ™‚é©—è­‰
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        const matchIndicator = document.getElementById('passwordMatch');
        
        if (confirmPassword && password !== confirmPassword) {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
            if (!password) {
                matchIndicator.style.color = '#dc3545';
                matchIndicator.textContent = 'è«‹å…ˆè¨­å®šå¯†ç¢¼';
            }
        } else if (confirmPassword && password === confirmPassword) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-invalid', 'is-valid');
        }
    });
    
    // æ­¥é©Ÿä¸‰ï¼šè¨­å®šå¯†ç¢¼ä¸¦å®Œæˆè¨»å†Š
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            showToast('å¯†ç¢¼ç¢ºèªä¸ä¸€è‡´', 'error');
            document.getElementById('confirmPassword').focus();
            return;
        }
        
        if (password.length < 6) {
            showToast('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'error');
            document.getElementById('password').focus();
            return;
        }
        
        const registerBtn = document.getElementById('registerBtn');
        const registerSpinner = document.getElementById('registerSpinner');
        const registerBtnText = document.getElementById('registerBtnText');
        
        setButtonLoading(registerBtn, registerSpinner, registerBtnText, true, 'è¨»å†Šä¸­...', 'ğŸ‰ å®Œæˆè¨»å†Š');
        
        // æ·»åŠ æäº¤å‹•ç•«
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 100);
        
        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: currentEmail,
                    password: password
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                updateStepIndicator(3, true);
                
                // æˆåŠŸå‹•ç•«
                registerBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                registerBtnText.textContent = 'ğŸ‰ è¨»å†ŠæˆåŠŸï¼';
                
                showToast('è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥BGGåˆ†æå¹³å°', 'success');
                
                // é é¢æ·¡å‡ºæ•ˆæœ
                setTimeout(() => {
                    document.body.style.transition = 'opacity 0.8s ease-out';
                    document.body.style.opacity = '0';
                    
                    setTimeout(() => {
                        window.location.href = result.redirect || '/dashboard';
                    }, 500);
                }, 1500);
            } else {
                // éŒ¯èª¤å‹•ç•«
                registerBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                registerBtnText.textContent = 'è¨»å†Šå¤±æ•—';
                
                showToast(result.message || 'è¨»å†Šå¤±æ•—', 'error');
                
                // æ–æ“ºå‹•ç•«
                this.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    this.style.animation = '';
                    registerBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    registerBtnText.textContent = 'é‡è©¦è¨»å†Š';
                }, 500);
            }
        } catch (error) {
            showToast('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            
            // ç¶²çµ¡éŒ¯èª¤å‹•ç•«
            registerBtn.style.background = 'linear-gradient(135deg, #ffc107, #fd7e14)';
            registerBtnText.textContent = 'ç¶²çµ¡éŒ¯èª¤';
            
            setTimeout(() => {
                registerBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                registerBtnText.textContent = 'é‡è©¦è¨»å†Š';
            }, 2000);
        } finally {
            setTimeout(() => {
                setButtonLoading(registerBtn, registerSpinner, registerBtnText, false, 'è¨»å†Šä¸­...', 'ğŸ‰ å®Œæˆè¨»å†Š');
            }, 1000);
        }
    });
    
    // éµç›¤å¿«æ·éµæ”¯æ´
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const activeElement = document.activeElement;
            if (currentStep === 1 && activeElement.id === 'email') {
                document.getElementById('emailForm').dispatchEvent(new Event('submit'));
            } else if (currentStep === 2 && activeElement.id === 'verifyCode') {
                document.getElementById('verifyForm').dispatchEvent(new Event('submit'));
            } else if (currentStep === 3 && (activeElement.id === 'password' || activeElement.id === 'confirmPassword')) {
                document.getElementById('passwordForm').dispatchEvent(new Event('submit'));
            }
        }
    });
});

// CSS å‹•ç•«
const style = document.createElement('style');
style.textContent = `
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.btn-auth:hover {
    animation: pulse 1.5s infinite;
}

.step-indicator .step {
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
`;
document.head.appendChild(style);
</script>
{% endblock %}